#!/usr/bin/env python3
"""Add alcohol licensing information to Pinecone RAG."""

import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from pinecone import Pinecone
from openai import OpenAI
import hashlib

LICENSING_DOCUMENT = """
# Ліцензія на алкоголь в Україні 2026 - Повний гід

## Основні вимоги для отримання ліцензії

### Фінансові вимоги (нові з 2026 року)

З 1 січня 2026 року діють обов'язкові вимоги до зарплат та доходів:

**Для закладів з працівниками:**
- Стандарт: середня зарплата не менше 17 294 грн (2 мінімалки)
- Для сільської місцевості: 12 970,50 грн (1,5 мінімалки)
  - Умова: всі точки продажу поза обласними центрами (>50 км), площа залу до 500 м²

**Для ФОП без працівників:**
- Місячний оподатковуваний дохід: 17 294 грн (або 12 970,50 грн для села)

КРИТИЧНО ВАЖЛИВО: Недотримання вимог протягом 3 календарних місяців поспіль = анулювання ліцензії!

### Технічні вимоги

- Реєстрація РРО/ПРРО (касовий апарат) — обов'язково навіть для пива
- Електронна ідентифікація в Електронному кабінеті ДПС
- Заява про згоду отримувати документи через е-кабінет (форма F/J1391602)
- Підтверджена адреса точки продажу
- Відсутність податкового боргу

### Вартість ліцензії у 2026 році

Плата залежить від локації та кількості РРО:

| Локація | Річна плата | Щоквартально |
|---------|-------------|--------------|
| Міста (стандарт) | 12 970 грн за кожен РРО | ~3 242 грн |
| Сільська місцевість | 691 грн за кожен РРО | ~173 грн |

Приклад розрахунку:
- Бар у Києві, 2 каси = 25 940 грн/рік (6 485 грн щокварталу)
- Магазин у селі, 1 каса = 691 грн/рік (173 грн щокварталу)

ВАЖЛИВО: Ліцензія безстрокова з 2025 року, але вимагає щоквартальної оплати.

## Як отримати ліцензію (покрокова інструкція)

### Крок 1: Підготовка
1. Зареєструйте РРО/ПРРО
2. Пройдіть електронну ідентифікацію на cabinet.tax.gov.ua
3. Подайте заяву F/J1391602 про згоду на е-листування

### Крок 2: Подання заяви

Заяву можна подати трьома способами:

**Онлайн (найзручніше):**
- Сайт: cabinet.tax.gov.ua/login
- Вхід: КЕП, хмарний підпис, BankID або Дія.Підпис
- Електронна форма заяви з підписом

**Особисто:**
- Центр обслуговування платників ДПС за місцем торгівлі

**Поштою:**
- Рекомендованим листом до обласного управління ДПС

### Крок 3: Очікування рішення
Термін розгляду: 10 робочих днів з дня отримання заяви

### Крок 4: Отримання ліцензії
- Ліцензія надається автоматично через Електронний кабінет
- Інформація вноситься до Єдиного реєстру ліцензіатів
- Торгівля можлива з дати внесення в реєстр

## Підстави для відмови

- Відсутність електронної ідентифікації в е-кабінеті
- Відмова від е-листування з ДПС
- Податковий борг з акцизного податку
- Анулювання ліцензії протягом останніх 12 місяців
- Порушення вимог нацбезпеки

## Контроль та штрафи

**ДПС моніторить:**
- Своєчасність щоквартальних платежів
- Дотримання зарплатних/дохідних лімітів (з 2026)
- Наявність РРО та видачу фіскальних чеків
- Маркування продукції акцизними марками

**Типові штрафи:**
- Продаж без РРО: 200% вартості партії, мінімум 10 000 грн
- Продаж без акцизних марок: анулювання ліцензії
- Продаж неповнолітнім: адміністративна та кримінальна відповідальність

## Моніторинг ліцензії в е-кабінеті

**Як перевірити строк сплати:**
1. Зайдіть на cabinet.tax.gov.ua
2. Меню → "Вхідні/вихідні документи" → "Вхідні"
3. Шукайте автоматичні нагадування

ДПС надсилає нагадування за 90, 75, 60, 45, 30 та 15 днів до дати платежу.

## Офіційні джерела та посилання

**Законодавство:**
- Закон України №3817-IX - Основний закон про регулювання обігу алкоголю (2024)
- Закон України №222-VIII - Про ліцензування видів господарської діяльності (2015)

**Електронні сервіси:**
- Електронний кабінет ДПС: cabinet.tax.gov.ua
- Гід Дія - Ліцензія на алкоголь: guide.diia.gov.ua
- Гаряча лінія ДПС: 0 800 501 007 (безкоштовно)

## Практичні поради для HoReCa

**Для власників барів/ресторанів:**

1. Плануйте бюджет заздалегідь
   - Квартальні платежі + зарплатні вимоги
   - Приклад: бар з 2 касами = 6 485 грн/квартал + зарплата персоналу мінімум 17 294 грн

2. Автоматизуйте контроль
   - Підключіть е-кабінет до бухгалтерії
   - Налаштуйте нагадування про платежі
   - Моніторте середню зарплату щомісяця

3. Враховуйте при плануванні персоналу
   - Нові зарплатні вимоги = додаткові витрати
   - Розрахунок: мінімум 17 294 грн × кількість працівників

**Частий кейс:**
Невеликий бар у Києві, 3 бармени:
- Ліцензія (1 каса): 3 242 грн/квартал
- Мінімальна зарплата: 17 294 × 3 = 51 882 грн/місяць
- Місячні витрати на комплаєнс: ~53 000 грн

## Часті питання

**Чи потрібна окрема ліцензія на пиво?**
Так, пиво є алкогольним напоєм за законом. Потрібна ліцензія + РРО.

**Скільки ліцензій потрібно, якщо у мене 3 заклади?**
Одна ліцензія, але кожна точка має бути внесена до реєстру. Плата — за кожен РРО.

**Що робити, якщо не встигаю оплатити вчасно?**
Ліцензія зупиняється після 30 днів прострочення. Після сплати + заяви — відновлюється.

**Чи можна торгувати під час розгляду заяви?**
Ні, торгівля можлива лише після внесення ліцензії до реєстру.

Джерела: Закон України №3817-IX, ДПС України, Дія.Гід (станом на січень 2026)
"""

def get_embedding(text: str, client: OpenAI) -> list:
    """Get embedding from OpenAI."""
    response = client.embeddings.create(
        model="text-embedding-3-small",
        input=text
    )
    return response.data[0].embedding

def main():
    openai_client = OpenAI()
    pc = Pinecone(api_key=os.environ.get("PINECONE_API_KEY"))
    index_name = os.environ.get("PINECONE_INDEX_NAME", "gradus-media")
    index = pc.Index(index_name)
    print(f"Using Pinecone index: {index_name}")
    
    doc_id = "licensing_ukraine_2026"
    
    print("Deleting old licensing document if exists...")
    try:
        index.delete(ids=[doc_id], namespace="company_knowledge")
        print("  Old document deleted")
    except Exception as e:
        print(f"  No old document found: {e}")
    
    print("\nCreating embedding for licensing document...")
    embedding = get_embedding(LICENSING_DOCUMENT, openai_client)
    print(f"  Embedding created: {len(embedding)} dimensions")
    
    print("\nUpserting to Pinecone (namespace: company_knowledge)...")
    index.upsert(
        vectors=[{
            "id": doc_id,
            "values": embedding,
            "metadata": {
                "source": "licensing_guide",
                "category": "legal",
                "company": "Gradus Media",
                "title": "Ліцензія на алкоголь в Україні 2026",
                "text": LICENSING_DOCUMENT[:8000],
                "keywords": "ліцензія алкоголь ліцензування license alcohol дпс рро прро вартість штрафи"
            }
        }],
        namespace="company_knowledge"
    )
    print("  Document upserted successfully!")
    
    print("\nVerifying...")
    stats = index.describe_index_stats()
    print(f"  Total vectors in index: {stats['total_vector_count']}")
    
    print("\n✅ Licensing document added to RAG!")

if __name__ == "__main__":
    main()
