# Debug: Why are documents not being attached?

## PROBLEM
Query "–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?" gets preset answer but NO document links appended.
No errors in logs, but also no "üìÑ Added N document links" message.

## INVESTIGATION NEEDED

### Step 1: Add detailed logging to document_service.py

In `find_documents_by_topics` method, add logging:
```python
@staticmethod
async def find_documents_by_topics(query: str, limit: int = 3) -> List[Dict]:
    """Find documents by matching query keywords to document topics."""
    import re
    
    # Extract keywords
    query_lower = query.lower()
    words = re.findall(r'\b\w{3,}\b', query_lower)
    stopwords = {'—è–∫–∏–π', '—è–∫', '—â–æ', '–∫–æ–ª–∏', '–¥–µ', '–º–æ–∂–Ω–∞', '—Ç—Ä–µ–±–∞', '–ø–æ—Ç—Ä—ñ–±–Ω–æ', '—á–æ–º—É'}
    keywords = [w for w in words if w not in stopwords]
    
    logger.info(f"üîç Document search: query='{query[:50]}', extracted keywords={keywords}")
    
    if not keywords:
        logger.warning("‚ùå No keywords extracted from query")
        return []
    
    # Database query
    from services.database import db
    
    try:
        result = await db.execute(
            text("""
                SELECT 
                    id, title, document_type, document_number,
                    url, category, description,
                    (
                        SELECT COUNT(*)
                        FROM unnest(topics) topic
                        WHERE topic = ANY(:keywords)
                    ) as relevance
                FROM hr_documents
                WHERE topics && CAST(:keywords AS varchar[])
                  AND is_active = TRUE
                ORDER BY relevance DESC, document_number
                LIMIT :limit
            """),
            {"keywords": keywords, "limit": limit}
        )
        
        rows = result.fetchall()
        docs = [dict(row._mapping) for row in rows]
        
        logger.info(f"üìÑ Found {len(docs)} documents matching keywords {keywords}")
        
        if docs:
            for doc in docs:
                logger.info(f"  ‚Ä¢ {doc['document_number']}: {doc['title']}")
        else:
            logger.warning(f"‚ö†Ô∏è No documents found for keywords: {keywords}")
        
        return docs
        
    except Exception as e:
        logger.error(f"‚ùå Document search error: {e}", exc_info=True)
        return []
```

### Step 2: Add logging to _attach_documents in hr_rag_service.py
```python
async def _attach_documents(self, query: str, answer_text: str) -> str:
    """Attach relevant document links to answer."""
    try:
        logger.info(f"üîó Attempting to attach documents for: '{query[:50]}'")
        
        documents = await document_service.find_documents(
            query=query,
            answer_text=answer_text,
            category=None
        )
        
        if documents:
            doc_links = document_service.format_documents_markdown(documents)
            logger.info(f"üìÑ Attaching {len(documents)} documents to answer")
            return answer_text + doc_links
        else:
            logger.info(f"‚ÑπÔ∏è No documents found to attach")
            return answer_text
            
    except Exception as e:
        logger.error(f"‚ùå Document attachment error: {e}", exc_info=True)
        return answer_text
```

### Step 3: Verify _attach_documents is called

In `get_answer_with_context`, confirm the method is called for preset path:
```python
# Around line 354 where preset answer is returned:
if preset_result:
    answer_text = preset_result['answer']
    
    # CONFIRM THIS LINE EXISTS:
    answer_text = await self._attach_documents(query, answer_text)
    
    return AnswerResponse(
        text=answer_text,
        # ...
    )
```

### Step 4: Test with known document

Verify that –î–æ–¥–∞—Ç–æ–∫ ‚Ññ33 exists and has correct topics:
```sql
SELECT id, title, document_number, topics, is_active 
FROM hr_documents 
WHERE document_number = '‚Ññ33';
```

Should return:
- topics should include: ['–±–ª—ñ—Ü', '—Å–µ–¥', '—Å–∏—Å—Ç–µ–º–∞', '–¥–æ—Å—Ç—É–ø']

### Step 5: Manual test
```python
# In Python console or test script:
from services.document_service import document_service

# Test 1: Extract keywords
keywords = document_service.extract_document_numbers("—à–∞–±–ª–æ–Ω ‚Ññ33")
print(f"Extracted numbers: {keywords}")

# Test 2: Find by topics
docs = await document_service.find_documents_by_topics("–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?")
print(f"Found docs: {docs}")

# Test 3: Full search
docs = await document_service.find_documents(
    query="–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?",
    answer_text="–¥–æ—Å—Ç—É–ø –¥–æ –°–ï–î –ë–ª—ñ—Ü"
)
print(f"Final docs: {docs}")
```

## EXPECTED OUTPUT

After adding logging, the next query should show:
```
üîç Document search: query='–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?', extracted keywords=['–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', '–±–ª—ñ—Ü']
üìÑ Found 1 documents matching keywords ['–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', '–±–ª—ñ—Ü']
  ‚Ä¢ ‚Ññ33: –î–æ–¥–∞—Ç–æ–∫ ‚Ññ33 - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ —Ä–æ–±–æ—Ç–∏ –≤ –°–ï–î –ë–ª—ñ—Ü / –£–†–°
üîó Attempting to attach documents for: '–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?'
üìÑ Attaching 1 documents to answer
```

## SUCCESS CRITERIA

- ‚úÖ Logs show keyword extraction
- ‚úÖ Logs show database query results
- ‚úÖ Logs show documents being attached
- ‚úÖ User receives answer with üìö **–î–æ–∫—É–º–µ–Ω—Ç–∏:** section