# REPLIT AGENT: FIX APPENDICES CALLBACK_DATA MAPPING

## üêõ CRITICAL BUG - WRONG DOCUMENTS OPENING

**Evidence from screenshots:**

| Button Clicked | Document That Opens | Should Open |
|----------------|---------------------|-------------|
| üíª –ë—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å –∑–∞–∫—É–ø—ñ–≤–ª—ñ —Ç–µ—Ö–Ω—ñ–∫–∏ | –î–æ–¥–∞—Ç–æ–∫_12.1_–ù–æ—Ä–º–∏_–≤–∏—Ç—Ä–∞—Ç ‚ùå | –î–æ–¥–∞—Ç–æ–∫_21.1_–ü—Ä–æ—Ü–µ—Å_–∑–∞–∫—É–ø—ñ–≤–ª—ñ_—Ç–µ—Ö–Ω—ñ–∫–∏ ‚úÖ |
| üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –æ—Ñ—ñ—Å—É | –î–æ–¥–∞—Ç–æ–∫_12_–†–∞–Ω–≥–∏_–ø–æ—Å–∞–¥ ‚ùå | –î–æ–¥–∞—Ç–æ–∫_22_–ö–æ–Ω—Ç–∞–∫—Ç–∏_–¶–û ‚úÖ |
| üí∞ –ù–æ—Ä–º–∏ –≤–∏—Ç—Ä–∞—Ç –Ω–∞ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è | –î–æ–¥–∞—Ç–æ–∫_21.1_–ü—Ä–æ—Ü–µ—Å_–∑–∞–∫—É–ø—ñ–≤–ª—ñ_—Ç–µ—Ö–Ω—ñ–∫–∏ ‚ùå | –î–æ–¥–∞—Ç–æ–∫_12.1_–ù–æ—Ä–º–∏_–≤–∏—Ç—Ä–∞—Ç ‚úÖ |
| üìä –¢–∞–±–ª–∏—Ü—è —Ä–∞–Ω–≥—ñ–≤ –ø–æ—Å–∞–¥ | –î–æ–¥–∞—Ç–æ–∫_22_–ö–æ–Ω—Ç–∞–∫—Ç–∏_–¶–û ‚ùå | –î–æ–¥–∞—Ç–æ–∫_12_–†–∞–Ω–≥–∏_–ø–æ—Å–∞–¥ ‚úÖ |

**Root Cause:** The `callback_data` IDs in button creation don't match the IDs in `CONTENT_MAP`.

---

## üîç DEBUGGING STEPS

### Step 1: Find where buttons are created

Search for where attachment buttons are generated. Should be in:
- `telegram_webhook.py` 
- `hr_keyboards.py`
- Or in the function `fetch_and_send_hr_content()`

Look for code like:
```python
keyboard.append([{
    "text": "üìä –¢–∞–±–ª–∏—Ü—è —Ä–∞–Ω–≥—ñ–≤ –ø–æ—Å–∞–¥",
    "callback_data": "content:???"  # ‚Üê This ID is wrong!
}])
```

### Step 2: Add logging to see actual callback_data

In `telegram_webhook.py`, find the webhook handler and add:

```python
@app.post("/webhook/telegram")
async def telegram_webhook(request: Request):
    data = await request.json()
    
    if "callback_query" in data:
        callback_data = data["callback_query"]["data"]
        
        # ADD THIS LOGGING:
        logger.info(f"üîç RAW CALLBACK DATA RECEIVED: {callback_data}")
        
        if callback_data.startswith("content:"):
            content_id = callback_data.replace("content:", "")
            logger.info(f"üîç CONTENT ID EXTRACTED: {content_id}")
            logger.info(f"üîç CHECKING CONTENT_MAP FOR: {content_id}")
            
            # Check if exists
            if content_id in CONTENT_MAP:
                content = CONTENT_MAP[content_id]
                logger.info(f"‚úÖ FOUND IN CONTENT_MAP: {content.get('title', 'NO TITLE')}")
            else:
                logger.error(f"‚ùå NOT FOUND IN CONTENT_MAP: {content_id}")
```

---

## ‚úÖ CORRECT MAPPING (REFERENCE)

### CONTENT_MAP should have these EXACT IDs:

```python
CONTENT_MAP = {
    # ... other content ...
    
    # APPENDICES - Google Docs Links
    "appendix_12_ranks": {
        "type": "link",
        "title": "üìä –¢–∞–±–ª–∏—Ü—è —Ä–∞–Ω–≥—ñ–≤ –ø–æ—Å–∞–¥ –¥–ª—è –≤—ñ–¥—Ä—è–¥–∂–µ–Ω—å",
        "description": "–ü–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–∞–¥ –∫–æ–º–ø–∞–Ω—ñ—ó –∑ —Ä–∞–Ω–≥–∞–º–∏",
        "url": "https://docs.google.com/document/d/1IJnIqDP5iGVXrjStxTELCtHDgISTzr2m/edit",
    },
    
    "appendix_12_1_norms": {
        "type": "link",
        "title": "üí∞ –ù–æ—Ä–º–∏ –≤–∏—Ç—Ä–∞—Ç –Ω–∞ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è",
        "description": "–î–µ—Ç–∞–ª—å–Ω—ñ –Ω–æ—Ä–º–∏ –≤–∏—Ç—Ä–∞—Ç –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏ —Ç–∞ –Ñ–≤—Ä–æ–ø–∏",
        "url": "https://docs.google.com/document/d/1e6_bQ9X36lFMWFojhV9A10BNB6Tcburz/edit",
    },
    
    "appendix_21_furniture": {
        "type": "link",
        "title": "ü™ë –ë—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å –∑–∞–∫—É–ø—ñ–≤–ª—ñ –º–µ–±–ª—ñ–≤",
        "description": "–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–µ–±–ª—ñ–≤",
        "url": "https://docs.google.com/document/d/1X8N5yR__-kydhqjKYZ_HFlLAI0oLrECZ/edit",
    },
    
    "appendix_21_1_equipment": {
        "type": "link",
        "title": "üíª –ë—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å –∑–∞–∫—É–ø—ñ–≤–ª—ñ —Ç–µ—Ö–Ω—ñ–∫–∏",
        "description": "–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–∏",
        "url": "https://docs.google.com/document/d/13vkM4p9XZWgFQ7AvkBziiT_-B90l8FEu/edit",
    },
    
    "appendix_22_contacts": {
        "type": "link",
        "title": "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –æ—Ñ—ñ—Å—É",
        "description": "–ü–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –¶–û",
        "url": "https://docs.google.com/document/d/1MLBli5A-cN5bMNCeZGM_wtKAMpjkBB0_/edit",
    },
}
```

### Questions (q12, q21) with attachments:

```python
"q12": {
    "type": "text",
    "title": "üöó –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è",
    "content": """...""",
    "attachments": ["appendix_12_ranks", "appendix_12_1_norms"]  # ‚Üê Must match EXACTLY!
},

"q21": {
    "type": "text",
    "title": "ü™ë –û—Å–Ω–æ–≤–Ω—ñ —Ñ–æ–Ω–¥–∏",
    "content": """...""",
    "attachments": ["appendix_21_furniture", "appendix_21_1_equipment"]  # ‚Üê Must match EXACTLY!
},
```

---

## üîß FIX THE BUTTON GENERATION

### Find the function that creates attachment buttons

Should look something like this:

```python
async def fetch_and_send_hr_content(chat_id: int, content_id: str):
    """Fetch and send HR content with attachments"""
    
    content = CONTENT_MAP.get(content_id)
    if not content:
        await send_telegram_message(chat_id, "‚ùå –ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        return
    
    # Send main content
    # ... code to send content ...
    
    # Send attachment buttons
    attachments = content.get("attachments", [])
    if attachments:
        keyboard = []
        
        for attachment_id in attachments:
            attachment = CONTENT_MAP.get(attachment_id)  # ‚Üê Get attachment from CONTENT_MAP
            
            if attachment:
                title = attachment.get("title", "–î–æ–¥–∞—Ç–æ–∫")
                
                # CRITICAL: callback_data must use the SAME attachment_id
                keyboard.append([{
                    "text": title,
                    "callback_data": f"content:{attachment_id}"  # ‚Üê THIS MUST MATCH CONTENT_MAP KEY!
                }])
        
        if keyboard:
            await send_telegram_message(
                chat_id,
                "üìé <b>–î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏:</b>",
                reply_markup={"inline_keyboard": keyboard}
            )
```

**CRITICAL CHECK:** The `callback_data` value must be `"content:{attachment_id}"` where `attachment_id` is the EXACT key from `CONTENT_MAP`.

---

## üîç COMMON MISTAKES TO CHECK

### Mistake 1: Hardcoded wrong IDs

```python
# ‚ùå WRONG - hardcoded IDs
keyboard = [
    [{"text": "üìä –†–∞–Ω–≥–∏", "callback_data": "content:appendix_22_contacts"}],  # Wrong ID!
    [{"text": "üí∞ –ù–æ—Ä–º–∏", "callback_data": "content:appendix_21_furniture"}]   # Wrong ID!
]

# ‚úÖ CORRECT - dynamically built from attachments list
for attachment_id in attachments:
    attachment = CONTENT_MAP.get(attachment_id)
    if attachment:
        keyboard.append([{
            "text": attachment["title"],
            "callback_data": f"content:{attachment_id}"  # Uses correct ID from loop
        }])
```

### Mistake 2: Wrong order in attachments list

```python
# ‚ùå WRONG ORDER
"q12": {
    "attachments": ["appendix_12_1_norms", "appendix_12_ranks"]  # Reversed!
}

# ‚úÖ CORRECT ORDER
"q12": {
    "attachments": ["appendix_12_ranks", "appendix_12_1_norms"]  # Logical order
}
```

### Mistake 3: Typos in attachment IDs

```python
# ‚ùå WRONG - typo
"attachments": ["appendix_12_rank"]  # Missing 's'

# ‚úÖ CORRECT
"attachments": ["appendix_12_ranks"]
```

---

## üß™ TESTING AFTER FIX

### Test Matrix:

| User Action | Expected Content ID | Expected Google Doc |
|-------------|---------------------|---------------------|
| Click "üìä –¢–∞–±–ª–∏—Ü—è —Ä–∞–Ω–≥—ñ–≤" from –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è | `appendix_12_ranks` | file_id: `1IJnIqDP5iGVXrjStxTELCtHDgISTzr2m` |
| Click "üí∞ –ù–æ—Ä–º–∏ –≤–∏—Ç—Ä–∞—Ç" from –í—ñ–¥—Ä—è–¥–∂–µ–Ω–Ω—è | `appendix_12_1_norms` | file_id: `1e6_bQ9X36lFMWFojhV9A10BNB6Tcburz` |
| Click "ü™ë –ü—Ä–æ—Ü–µ—Å –º–µ–±–ª—ñ–≤" from –û—Å–Ω–æ–≤–Ω—ñ —Ñ–æ–Ω–¥–∏ | `appendix_21_furniture` | file_id: `1X8N5yR__-kydhqjKYZ_HFlLAI0oLrECZ` |
| Click "üíª –ü—Ä–æ—Ü–µ—Å —Ç–µ—Ö–Ω—ñ–∫–∏" from –û—Å–Ω–æ–≤–Ω—ñ —Ñ–æ–Ω–¥–∏ | `appendix_21_1_equipment` | file_id: `13vkM4p9XZWgFQ7AvkBziiT_-B90l8FEu` |
| Click "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏" button | `appendix_22_contacts` | file_id: `1MLBli5A-cN5bMNCeZGM_wtKAMpjkBB0_` |

### Verification Method:

After clicking each button, check Render logs for:
```
üîç RAW CALLBACK DATA RECEIVED: content:appendix_12_ranks
üîç CONTENT ID EXTRACTED: appendix_12_ranks
üîç CHECKING CONTENT_MAP FOR: appendix_12_ranks
‚úÖ FOUND IN CONTENT_MAP: üìä –¢–∞–±–ª–∏—Ü—è —Ä–∞–Ω–≥—ñ–≤ –ø–æ—Å–∞–¥ –¥–ª—è –≤—ñ–¥—Ä—è–¥–∂–µ–Ω—å
```

Then verify the Google Docs link sent to user matches the expected file_id.

---

## üìã COMPLETE FIX CHECKLIST

### 1. Verify CONTENT_MAP has correct IDs and URLs ‚úÖ
```python
# Check backend/services/maya_hr_content.py
# Ensure all 5 appendix IDs exist with correct URLs
```

### 2. Verify attachments arrays in q12 and q21 ‚úÖ
```python
"q12": {
    "attachments": ["appendix_12_ranks", "appendix_12_1_norms"]
}
"q21": {
    "attachments": ["appendix_21_furniture", "appendix_21_1_equipment"]
}
```

### 3. Fix button generation logic ‚úÖ
```python
# In telegram_webhook.py or wherever buttons are created
# Use: callback_data=f"content:{attachment_id}"
# Where attachment_id comes from the attachments loop
```

### 4. Add debug logging ‚úÖ
```python
# Log callback_data received
# Log content_id extracted
# Log if found in CONTENT_MAP
```

### 5. Deploy and test all 5 appendices ‚úÖ
```
- appendix_12_ranks ‚Üí Opens ranks table
- appendix_12_1_norms ‚Üí Opens expense norms
- appendix_21_furniture ‚Üí Opens furniture process
- appendix_21_1_equipment ‚Üí Opens equipment process
- appendix_22_contacts ‚Üí Opens contacts table
```

---

## üö® CRITICAL: Print Current State

**Add this temporary diagnostic code to see current mapping:**

```python
# Add to telegram_webhook.py after imports
import json

@app.on_event("startup")
async def log_appendix_mapping():
    """Log current appendix mapping for debugging"""
    logger.info("=" * 60)
    logger.info("APPENDIX MAPPING DIAGNOSTIC")
    logger.info("=" * 60)
    
    appendix_ids = [
        "appendix_12_ranks",
        "appendix_12_1_norms", 
        "appendix_21_furniture",
        "appendix_21_1_equipment",
        "appendix_22_contacts"
    ]
    
    for app_id in appendix_ids:
        if app_id in CONTENT_MAP:
            content = CONTENT_MAP[app_id]
            logger.info(f"‚úÖ {app_id}")
            logger.info(f"   Title: {content.get('title', 'MISSING')}")
            logger.info(f"   URL: {content.get('url', 'MISSING')[:60]}...")
        else:
            logger.error(f"‚ùå {app_id} - NOT FOUND IN CONTENT_MAP")
    
    # Check attachments
    logger.info("\nATTACHMENTS CHECK:")
    for content_id in ["q12", "q21"]:
        if content_id in CONTENT_MAP:
            attachments = CONTENT_MAP[content_id].get("attachments", [])
            logger.info(f"{content_id}: {attachments}")
    
    logger.info("=" * 60)
```

This will print the current state when the app starts. Check Render logs to see if there are any mismatches.

---

## üéØ EXPECTED OUTCOME

After fix, clicking any appendix button should:

1. Log shows correct callback_data received
2. Log shows correct content_id extracted  
3. Log shows content found in CONTENT_MAP
4. Correct Google Docs link sent to user
5. User opens correct document

**No more wrong documents opening!** ‚úÖ

---

**DEPLOY IMMEDIATELY after making these fixes. Then test all 5 appendices one by one.**