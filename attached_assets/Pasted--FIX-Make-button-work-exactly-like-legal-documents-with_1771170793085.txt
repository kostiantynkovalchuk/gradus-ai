# FIX: Make "–ù–∞–≤—á–∞–Ω–Ω—è" button work exactly like legal documents with rich preview

## PROBLEM
1. Admin buttons crash: `answer_callback_query is not defined`
2. "–ù–∞–≤—á–∞–Ω–Ω—è" button opens direct link instead of showing rich Google Docs preview card like legal documents

## REFERENCE: How legal documents work (correct behavior)
When user clicks legal document button:
1. Shows rich preview card with "–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" link
2. Displays Google Docs icon and document preview
3. Shows document title and description
4. Has navigation buttons below (e.g., "üíº –†–æ–±–æ—á—ñ –ø–∏—Ç–∞–Ω–Ω—è", "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é")

## FIX 1: Admin buttons crash

**File: `backend/routes/telegram_webhook.py` around line 676**

**Find:**
```python
await answer_callback_query(callback_id, f"–í–∏–∫–æ–Ω—É—é {cmd}...")
```

**Diagnose:** Check what other callbacks use in the same file. Look for successful callback patterns.

**Likely fix options:**
```python
# Option A: Direct bot method
await bot.answer_callback_query(callback_id, text=f"–í–∏–∫–æ–Ω—É—é {cmd}...")

# Option B: If there's an answer_callback function
await answer_callback(callback_id, f"–í–∏–∫–æ–Ω—É—é {cmd}...")

# Option C: Using callback query object directly  
await callback_query.answer(f"–í–∏–∫–æ–Ω—É—é {cmd}...")
```

**Action:** Find how legal document callbacks successfully answer (they work in logs), copy that exact pattern.

## FIX 2: Make –ù–∞–≤—á–∞–Ω–Ω—è work like legal documents

### Investigation needed:

1. **Find how legal documents create that rich preview**
   - Search for code that sends Google Docs links
   - Look for where "–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" link is generated
   - Find the message format that creates the preview card

2. **Likely using Telegram's link preview feature**
   - When sending message with Google Docs URL
   - Telegram auto-generates rich preview
   - Need correct message format

### Implementation:

**Step 1: Find existing legal document message format**

Search codebase for where legal documents are sent. Look for:
- Message that includes Google Docs URL
- Format that triggers rich preview
- Navigation buttons structure

**Likely pattern (find the actual code):**
```python
# When sending legal document:
message = f"""
üìÑ **{document_title}**

{document_description}

üîó {google_docs_url}
"""

keyboard = ReplyKeyboardMarkup([
    ["üíº –†–æ–±–æ—á—ñ –ø–∏—Ç–∞–Ω–Ω—è", "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é"]
])

await update.message.reply_text(
    message,
    parse_mode="Markdown",
    reply_markup=keyboard,
    disable_web_page_preview=False  # Important: allows rich preview
)
```

**Step 2: Apply same pattern to training document**

**Find where "üìö –ù–∞–≤—á–∞–Ω–Ω—è" button is handled and replace with:**
```python
if message_text == "üìö –ù–∞–≤—á–∞–Ω–Ω—è":
    # Use EXACT same format as legal documents
    training_doc_url = "https://docs.google.com/document/d/1Xm8wPB4Rwcj_4G50jXDLq_fANV_vvpLiyK_usrKIMs4/edit"
    
    message = f"""
üìö **–ù–∞–≤—á–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏**

–ü–æ–≤–Ω–∏–π –ø–æ—Å—ñ–±–Ω–∏–∫ –∑ —Ä–æ–±–æ—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—ñ ¬´–ë–ª—ñ—Ü¬ª —Ç–∞ HR-–ø—Ä–æ—Ü–µ—Å—ñ–≤

üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç
{training_doc_url}

–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —â–æ–¥–æ –ø—ñ–¥–±–æ—Ä—É, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è —Ç–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤.
"""
    
    # Get user's keyboard
    user = await db.fetchrow(
        "SELECT access_level FROM hr_users WHERE telegram_id = $1",
        update.effective_user.id
    )
    keyboard = get_menu_for_access_level(user["access_level"]) if user else None
    
    await update.message.reply_text(
        message,
        parse_mode="Markdown",
        reply_markup=keyboard,
        disable_web_page_preview=False  # CRITICAL: enables rich preview
    )
    return
```

**Step 3: Verify the format**

**Critical settings for rich Google Docs preview:**
- ‚úÖ `disable_web_page_preview=False` (default, but make explicit)
- ‚úÖ Include full Google Docs URL in message
- ‚úÖ Use Markdown formatting
- ‚úÖ Include descriptive text

**Alternative if above doesn't work - use inline keyboard:**
```python
# If rich preview doesn't work, use inline button like legal docs might:
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

keyboard_inline = InlineKeyboardMarkup([
    [InlineKeyboardButton("üìñ –í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç", url=training_doc_url)]
])

keyboard_reply = get_menu_for_access_level(user["access_level"])

await update.message.reply_text(
    "üìö **–ù–∞–≤—á–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏**\n\n"
    "HR-–ø—Ä–æ—Ü–µ—Å–∏ —Ç–∞ —Ä–æ–±–æ—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º—ñ ¬´–ë–ª—ñ—Ü¬ª\n\n"
    "–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —â–æ–¥–æ –ø—ñ–¥–±–æ—Ä—É, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è —Ç–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤.",
    parse_mode="Markdown",
    reply_markup=keyboard_inline  # Inline button for document
)

# Send keyboard separately if needed
await update.message.reply_text(
    "–ú–µ–Ω—é:",
    reply_markup=keyboard_reply
)
```

## ACTION STEPS

1. **Find the exact code** where legal documents are sent successfully
2. **Copy that exact pattern** - don't reinvent
3. **Apply to training document** with same format
4. **Fix admin callback function name** using working callback pattern
5. **Test both fixes**

## TESTING CHECKLIST

**–ù–∞–≤—á–∞–Ω–Ω—è button:**
1. Click "üìö –ù–∞–≤—á–∞–Ω–Ω—è" 
2. Should show rich preview card (like screenshot)
3. "–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" link should be visible
4. Google Docs icon and preview should appear
5. Navigation buttons below
6. Clicking link opens Google Doc in browser

**Admin buttons:**
1. Click "üë®‚Äçüíª Admin" ‚Üí no crash
2. Click "üìä Stats" ‚Üí works
3. Click "üîç Logs" ‚Üí works
4. No `NameError` in logs

## WHERE TO LOOK

**Files to check:**
- `backend/routes/telegram_webhook.py` - main webhook handler
- `backend/routes/hr_routes.py` or similar - where legal docs might be handled
- Search for "–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" in codebase
- Search for "–Æ—Ä–∏–¥–∏—á–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏" handler

**Search patterns:**
```bash
grep -r "–í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç" backend/
grep -r "disable_web_page_preview" backend/
grep -r "–Æ—Ä–∏–¥–∏—á–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏" backend/
grep -r "google.com/document" backend/
```

FIND THE LEGAL DOCUMENTS CODE AND REPLICATE IT EXACTLY FOR TRAINING.