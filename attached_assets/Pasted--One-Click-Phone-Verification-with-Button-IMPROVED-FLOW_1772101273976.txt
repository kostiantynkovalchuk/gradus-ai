# One-Click Phone Verification with Button

## IMPROVED FLOW
User sends phone â†’ Maya stores it â†’ User clicks confirm â†’ Instant verification

## IMPLEMENTATION

### Step 1: Store phone in context
```python
@router.message(F.text & ~F.command())
async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Route user messages."""
    
    user = update.effective_user
    telegram_id = user.id
    message_text = update.message.text.strip()
    
    # Check authentication
    user_data = await get_user_from_db(telegram_id)
    
    if not user_data or not user_data.get('verified'):
        # User not authenticated
        
        # Detect if they sent a phone number
        if is_phone_number(message_text):
            # Store phone in context for later use
            context.user_data['pending_phone'] = message_text
            
            logger.info(f"ðŸ“± Phone stored for {telegram_id}: {message_text}")
            
            # Show confirmation button
            keyboard = [
                [InlineKeyboardButton(
                    text="âœ… ÐŸÑ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ð¸ Ñ– Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÑƒÐ²Ð°Ñ‚Ð¸ÑÑŒ",
                    callback_data=f"auth:verify_phone:{message_text}"
                )],
                [InlineKeyboardButton(
                    text="âœï¸ Ð’Ð²ÐµÑÑ‚Ð¸ Ñ–Ð½ÑˆÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€",
                    callback_data="auth:start"
                )]
            ]
            
            await update.message.reply_text(
                f"ðŸ“± ÐÐ¾Ð¼ÐµÑ€ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾: `{message_text}`\n\n"
                f"ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ—:",
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='Markdown'
            )
            return
        
        else:
            # Regular message from unauthenticated user
            await update.message.reply_text(
                f"ðŸ‘‹ ÐŸÑ€Ð¸Ð²Ñ–Ñ‚, {user.first_name}!\n\n"
                f"Ð”Ð»Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð·Ñ– Ð¼Ð½Ð¾ÑŽ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ.\n\n"
                f"ÐÐ°Ð´Ñ–ÑˆÐ»Ð¸ ÑÐ²Ñ–Ð¹ Ñ€Ð¾Ð±Ð¾Ñ‡Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ:\n"
                f"ðŸ“± Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: `+380501234567` Ð°Ð±Ð¾ `0501234567`",
                parse_mode='Markdown'
            )
            return
    
    # Authenticated user - route to HR service
    # ... existing logic ...
```

### Step 2: Handle verify button click
```python
@router.callback_query()
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button clicks."""
    
    query = update.callback_query
    await query.answer()
    
    callback_data = query.data
    telegram_id = query.from_user.id
    
    # Phone verification button
    if callback_data.startswith("auth:verify_phone:"):
        phone = callback_data.replace("auth:verify_phone:", "")
        
        logger.info(f"âœ… Verifying phone {phone} for {telegram_id}")
        
        # Show loading message
        await query.message.edit_text(
            f"ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑŽ Ð½Ð¾Ð¼ÐµÑ€ {phone}...\n"
            f"Ð—Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ ÐºÑ–Ð»ÑŒÐºÐ° ÑÐµÐºÑƒÐ½Ð´."
        )
        
        try:
            # Call SED API
            from services.hr_sed_service import verify_employee_in_sed
            
            employee = await verify_employee_in_sed(phone)
            
            if employee:
                # Success!
                await save_verified_user(telegram_id, employee)
                
                # Clear pending phone
                context.user_data.pop('pending_phone', None)
                
                # Show success with main menu
                await query.message.edit_text(
                    f"âœ… Ð’Ñ–Ñ‚Ð°ÑŽ, {employee['full_name']}!\n\n"
                    f"Ð’Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ–.\n"
                    f"ðŸ“‹ ÐŸÐ¾ÑÐ°Ð´Ð°: {employee.get('position', 'N/A')}\n"
                    f"ðŸ¢ Ð’Ñ–Ð´Ð´Ñ–Ð»: {employee.get('department', 'N/A')}\n\n"
                    f"Ð¢ÐµÐ¿ÐµÑ€ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÑ‚Ð°Ð²Ð¸Ñ‚Ð¸ Ð±ÑƒÐ´ÑŒ-ÑÐºÑ– HR-Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ! ðŸ’¬",
                    reply_markup=get_hr_main_menu_keyboard()
                )
                
            else:
                # Not found
                keyboard = [
                    [InlineKeyboardButton(
                        text="ðŸ”„ Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ²Ð°Ñ‚Ð¸ Ñ–Ð½ÑˆÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€",
                        callback_data="auth:start"
                    )],
                    [InlineKeyboardButton(
                        text="ðŸ“ž Ð—Ð²'ÑÐ·Ð°Ñ‚Ð¸ÑÑŒ Ð· HR",
                        url="mailto:hr@vinkom.net"
                    )]
                ]
                
                await query.message.edit_text(
                    f"âŒ ÐÐ¾Ð¼ÐµÑ€ `{phone}` Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² Ð±Ð°Ð·Ñ– TD AV.\n\n"
                    f"ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ– Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð¸:\n"
                    f"â€¢ ÐÐ¾Ð¼ÐµÑ€ Ð½Ðµ Ð·Ð°Ñ€ÐµÑ”ÑÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð² Ð‘Ð»Ñ–Ñ†\n"
                    f"â€¢ Ð’Ð¸ Ñ‰Ðµ Ð½Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ñ– ÑÐº ÑÐ¿Ñ–Ð²Ñ€Ð¾Ð±Ñ–Ñ‚Ð½Ð¸Ðº\n"
                    f"â€¢ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ– Ð½Ð¾Ð¼ÐµÑ€Ð°\n\n"
                    f"Ð©Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸:",
                    reply_markup=InlineKeyboardMarkup(keyboard),
                    parse_mode='Markdown'
                )
                
        except Exception as e:
            logger.error(f"Verification error: {e}", exc_info=True)
            
            keyboard = [
                [InlineKeyboardButton(
                    text="ðŸ”„ Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‰Ðµ Ñ€Ð°Ð·",
                    callback_data=f"auth:verify_phone:{phone}"
                )]
            ]
            
            await query.message.edit_text(
                f"âŒ Ð’Ð¸Ð½Ð¸ÐºÐ»Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ñ†Ñ–.\n\n"
                f"Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‰Ðµ Ñ€Ð°Ð· Ð°Ð±Ð¾ Ð·Ð²ÐµÑ€Ð½Ñ–Ñ‚ÑŒÑÑ Ð´Ð¾ HR-Ð²Ñ–Ð´Ð´Ñ–Ð»Ñƒ.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
        
        return
    
    # Start/restart auth flow
    if callback_data == "auth:start":
        await query.message.edit_text(
            f"ðŸ‘‹ ÐŸÑ€Ð¸Ð²Ñ–Ñ‚, {query.from_user.first_name}!\n\n"
            f"ÐÐ°Ð´Ñ–ÑˆÐ»Ð¸ ÑÐ²Ñ–Ð¹ Ñ€Ð¾Ð±Ð¾Ñ‡Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ:\n\n"
            f"ðŸ“± Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: `+380501234567` Ð°Ð±Ð¾ `0501234567`",
            parse_mode='Markdown'
        )
        return
    
    # ... existing callback handlers (hr_menu, feedback, etc.)
```

### Step 3: Add phone number validator
```python
def is_phone_number(text: str) -> bool:
    """
    Detect if message is a phone number.
    """
    if not text:
        return False
    
    # Remove spaces, dashes, parentheses
    cleaned = re.sub(r'[\s\-\(\)]', '', text.strip())
    
    # Check format
    if not re.match(r'^\+?\d+$', cleaned):
        return False
    
    # Length check (10-15 digits)
    digit_count = len(cleaned.replace('+', ''))
    
    return 10 <= digit_count <= 15
```

## COMPLETE USER FLOW

### Happy Path âœ…
```
User: +380503343534

Maya: ðŸ“± ÐÐ¾Ð¼ÐµÑ€ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾: +380503343534
      
      ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð´Ð»Ñ Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ—:
      
      [âœ… ÐŸÑ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ð¸ Ñ– Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÑƒÐ²Ð°Ñ‚Ð¸ÑÑŒ]
      [âœï¸ Ð’Ð²ÐµÑÑ‚Ð¸ Ñ–Ð½ÑˆÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€]

User: [clicks âœ…]

Maya: ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑŽ Ð½Ð¾Ð¼ÐµÑ€ +380503343534...
      Ð—Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ ÐºÑ–Ð»ÑŒÐºÐ° ÑÐµÐºÑƒÐ½Ð´.

Maya: âœ… Ð’Ñ–Ñ‚Ð°ÑŽ, Vasile Rotaru!
      
      Ð’Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ–.
      ðŸ“‹ ÐŸÐ¾ÑÐ°Ð´Ð°: Marketing Director
      ðŸ¢ Ð’Ñ–Ð´Ð´Ñ–Ð»: Marketing
      
      Ð¢ÐµÐ¿ÐµÑ€ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÑ‚Ð°Ð²Ð¸Ñ‚Ð¸ Ð±ÑƒÐ´ÑŒ-ÑÐºÑ– HR-Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ! ðŸ’¬
      
      [ðŸ“‹ HR Ð¼ÐµÐ½ÑŽ]
      [ðŸ’¬ Ð—Ð°Ð¿Ð¸Ñ‚Ð°Ñ‚Ð¸]
```

### Error Path âŒ
```
User: +380123456789

Maya: ðŸ“± ÐÐ¾Ð¼ÐµÑ€ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾: +380123456789
      [âœ… ÐŸÑ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ð¸ Ñ– Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÑƒÐ²Ð°Ñ‚Ð¸ÑÑŒ]

User: [clicks âœ…]

Maya: ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑŽ...

Maya: âŒ ÐÐ¾Ð¼ÐµÑ€ +380123456789 Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² Ð±Ð°Ð·Ñ– TD AV.
      
      ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ– Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð¸:
      â€¢ ÐÐ¾Ð¼ÐµÑ€ Ð½Ðµ Ð·Ð°Ñ€ÐµÑ”ÑÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð² Ð‘Ð»Ñ–Ñ†
      â€¢ Ð’Ð¸ Ñ‰Ðµ Ð½Ðµ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ñ– ÑÐº ÑÐ¿Ñ–Ð²Ñ€Ð¾Ð±Ñ–Ñ‚Ð½Ð¸Ðº
      
      [ðŸ”„ Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ²Ð°Ñ‚Ð¸ Ñ–Ð½ÑˆÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€]
      [ðŸ“ž Ð—Ð²'ÑÐ·Ð°Ñ‚Ð¸ÑÑŒ Ð· HR]
```

### Wrong Input Path ðŸ”„
```
User: Hello

Maya: ðŸ‘‹ ÐŸÑ€Ð¸Ð²Ñ–Ñ‚!
      
      Ð”Ð»Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð·Ñ– Ð¼Ð½Ð¾ÑŽ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð²ÐµÑ€Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ.
      
      ÐÐ°Ð´Ñ–ÑˆÐ»Ð¸ ÑÐ²Ñ–Ð¹ Ñ€Ð¾Ð±Ð¾Ñ‡Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ:
      ðŸ“± Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: +380501234567 Ð°Ð±Ð¾ 0501234567
```

## KEY IMPROVEMENTS
âœ… User sends phone ONCE (not twice)
âœ… Clear confirmation before verification
âœ… Loading state during API call
âœ… Option to change number if typo
âœ… Direct link to HR if issues
âœ… Clean error handling

## TESTING CHECKLIST
- [ ] Send valid phone â†’ confirm â†’ success
- [ ] Send invalid phone â†’ confirm â†’ clear error
- [ ] Click "Ñ–Ð½ÑˆÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€" â†’ can re-enter
- [ ] Multiple format variations work (with +, without, spaces)
- [ ] Loading message shows during verification
- [ ] Success shows employee details