
# URGENT: Fix 3 Critical Maya HR Bugs

## BUG 1: Fix SED API 401 Unauthorized Error

**Problem:** SED API returns HTTP 401 - authentication failing

**Investigation:**
1. Check current API key in environment:
```bash
# In Render dashboard, check:
SED_API_KEY=f10e2b75-2c4c-4e26-be72-98d1a6aafa4c
```

2. Test SED API manually:
```bash
curl -X POST https://api-sed.tdav.net.ua/api/employees \
  -H "X-API-Key: f10e2b75-2c4c-4e26-be72-98d1a6aafa4c" \
  -H "Content-Type: application/json" \
  -d '{"phone": "+380671234567"}'
```

**Fix:**
- If key is wrong ‚Üí Get correct key from AVTD IT and update in Render
- If endpoint changed ‚Üí Update SED_API_URL
- Add better error handling to show specific error to user

---

## BUG 2: Add "employee" to /adduser Access Levels

**Problem:** /adduser command rejects "employee" access level

**Find the validation code:**
```bash
grep -r "contractor, admin_hr, admin_it, developer" backend/
# Or
grep -r "–ù–µ–≤—ñ—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø—É" backend/
```

**Fix:**

**File: Likely in `backend/routes/hr_admin_commands.py` or similar**

**Find this:**
```python
ALLOWED_ACCESS_LEVELS = ["contractor", "admin_hr", "admin_it", "developer"]

# Or validation like:
if access_level not in ["contractor", "admin_hr", "admin_it", "developer"]:
    return "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø—É..."
```

**Change to:**
```python
ALLOWED_ACCESS_LEVELS = ["employee", "contractor", "admin_hr", "admin_it", "developer"]

# Update error message:
if access_level not in ALLOWED_ACCESS_LEVELS:
    return (
        "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø—É. –î–æ—Å—Ç—É–ø–Ω—ñ:\n"
        "‚Ä¢ employee - –∑–≤–∏—á–∞–π–Ω–∏–π —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫\n"
        "‚Ä¢ contractor - –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç\n"
        "‚Ä¢ admin_hr - HR –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä\n"
        "‚Ä¢ admin_it - IT –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä\n"
        "‚Ä¢ developer - —Ä–æ–∑—Ä–æ–±–Ω–∏–∫\n\n"
        "–ü—Ä–∏–∫–ª–∞–¥:\n"
        "/adduser +380671234567 –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤ employee –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –≤—ñ–¥–¥—ñ–ª—É –ø—Ä–æ–¥–∞–∂—ñ–≤"
    )
```

**Update help message for /adduser:**
```python
async def adduser_help():
    return """
üìù **–ö–æ–º–∞–Ω–¥–∞ /adduser**

–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤—Ä—É—á–Ω—É (–¥–ª—è HR –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤)

**–§–æ—Ä–º–∞—Ç:**
/adduser +380XXXXXXXXX –Ü–º'—è –ü—Ä—ñ–∑–≤–∏—â–µ access_level –ø—Ä–∏—á–∏–Ω–∞

**–†—ñ–≤–Ω—ñ –¥–æ—Å—Ç—É–ø—É:**
- `employee` - –∑–≤–∏—á–∞–π–Ω–∏–π —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ TD AV
- `contractor` - –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
- `admin_hr` - HR –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä
- `admin_it` - IT –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä  
- `developer` - —Ä–æ–∑—Ä–æ–±–Ω–∏–∫ —Å–∏—Å—Ç–µ–º–∏

**–ü—Ä–∏–∫–ª–∞–¥–∏:**

–î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞:
/adduser +380671234567 –û–ª–µ–≥ –ü–µ—Ç—Ä–µ–Ω–∫–æ employee –¢–æ—Ä–≥–æ–≤–∏–π –ø—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏–∫

–î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞:
/adduser +380501234567 –ú–∞—Ä—ñ—è –Ü–≤–∞–Ω–æ–≤–∞ contractor –ó–æ–≤–Ω—ñ—à–Ω—ñ–π HR-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
"""
```

---

## BUG 3: RAG Not Working - Maya Ignores Knowledge Base

**Problem:** Maya responds with generic info instead of using AVTD training documents

**Investigation Steps:**

### Step 1: Check if Training Document is in Database
```sql
-- Connect to PostgreSQL and run:
SELECT id, section, subsection, title 
FROM hr_content 
WHERE section = 'training' 
  AND subsection = 'hr_processes_blitz';

-- Check if embeddings exist:
SELECT COUNT(*) FROM hr_embeddings 
WHERE content_id IN (
  SELECT id FROM hr_content WHERE section = 'training'
);
```

### Step 2: Check RAG Pipeline Code

**Find the chat/query processing code:**
```bash
grep -r "openai.com/v1/embeddings" backend/
grep -r "pinecone" backend/
grep -r "rag" backend/ -i
```

**Look for these files:**
- `backend/services/hr_rag_service.py`
- `backend/routes/chat_endpoints.py`
- `backend/services/hr_query_processor.py`

### Step 3: Verify RAG is Called

**Check if RAG search happens before Claude API call:**

**Correct flow should be:**
```python
# 1. Generate embedding for user query
embedding = await openai.embeddings.create(
    model="text-embedding-3-small",
    input=user_message
)

# 2. Search Pinecone for relevant content
results = pinecone_index.query(
    vector=embedding.data[0].embedding,
    top_k=3,
    include_metadata=True,
    namespace="hr_content"  # Make sure namespace is correct!
)

# 3. Extract relevant context
context = "\n\n".join([
    match.metadata.get("content", "") 
    for match in results.matches 
    if match.score > 0.7  # Only high-relevance matches
])

# 4. Build system prompt with context
system_prompt = f"""
–¢–∏ Maya, HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç –¢–æ—Ä–≥–æ–≤–æ–≥–æ –î–æ–º—É –ê–í.

–í–ê–ñ–õ–ò–í–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –Ω–∞–¥–∞–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ TD AV.

–ö–û–ù–¢–ï–ö–°–¢ –ó –î–û–ö–£–ú–ï–ù–¢–Ü–í TD AV:
{context}

–Ø–∫—â–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–µ–º–∞—î –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ, —Å–∫–∞–∂–∏ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ HR-–≤—ñ–¥–¥—ñ–ª.
"""

# 5. Call Claude with context
response = await claude_api.messages.create(
    model="claude-haiku-4-5-20251001",
    system=system_prompt,
    messages=[{"role": "user", "content": user_message}]
)
```

### Step 4: Check Pinecone Namespace

**Problem might be wrong namespace:**
```python
# Check if code uses correct namespace
results = pinecone_index.query(
    vector=embedding,
    namespace="hr_content"  # ‚Üê Check this!
)

# List all namespaces to verify:
stats = pinecone_index.describe_index_stats()
print(stats.namespaces)  # Should show 'hr_content' with vectors
```

#...