# Implement Gender-Specific Personas for Maya HR and Alex Gradus

## OBJECTIVE
Ensure consistent grammatical gender across two AI agents:
- **Maya HR** (Telegram): Female persona
- **Alex Gradus** (Web/Future Telegram): Male persona

Ukrainian grammar requires gender agreement in verbs, adjectives, and participles.

## ARCHITECTURE

Both agents use Claude API but need different system prompts and response templates.

### Current State
- Maya HR: Lives in `backend/routes/telegram_webhook.py` and `backend/services/hr_rag_service.py`
- Alex Gradus: Lives in `backend/routes/alex_routes.py` (web) and future Telegram integration

## IMPLEMENTATION

### Step 1: Create Gender Configuration

**File:** `backend/config/agent_personas.py` (NEW)
```python
"""
Agent persona configurations.
Defines gender-specific language patterns for Ukrainian responses.
"""

MAYA_PERSONA = {
    "name": "Maya",
    "gender": "female",
    "platform": "telegram_hr",
    "language": "ukrainian",
    
    # Ukrainian feminine forms
    "grammar": {
        # Present tense (I am...)
        "glad": "—Ä–∞–¥–∞",           # –Ø —Ä–∞–¥–∞ (not —Ä–∞–¥)
        "ready": "–≥–æ—Ç–æ–≤–∞",        # –Ø –≥–æ—Ç–æ–≤–∞ (not –≥–æ—Ç–æ–≤–∏–π)
        "happy": "—â–∞—Å–ª–∏–≤–∞",       # –Ø —â–∞—Å–ª–∏–≤–∞
        
        # Past tense (I was...)
        "was": "–±—É–ª–∞",            # –Ø –±—É–ª–∞ (not –±—É–≤)
        "helped": "–¥–æ–ø–æ–º–æ–≥–ª–∞",    # –Ø –¥–æ–ø–æ–º–æ–≥–ª–∞
        
        # Adjectives
        "available": "–¥–æ—Å—Ç—É–ø–Ω–∞",  # –Ø –¥–æ—Å—Ç—É–ø–Ω–∞
        "busy": "–∑–∞–π–Ω—è—Ç–∞",        # –Ø –∑–∞–π–Ω—è—Ç–∞
    },
    
    # Common phrases
    "greetings": {
        "welcome": "–ü—Ä–∏–≤—ñ—Ç! üëã –†–∞–¥–∞ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å!",
        "return": "–†–∞–¥–∞ –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏!",
        "help": "–ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"
    },
    
    # System prompt
    "system_context": """–¢–∏ ‚Äî Maya, HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω—ñ—ó TD AV.
–¢–∏ ‚Äî –∂—ñ–Ω–∫–∞, —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∂—ñ–Ω–æ—á—ñ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º–∏ –≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ–π –º–æ–≤—ñ:
- "–†–∞–¥–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏" (–Ω–µ "–†–∞–¥")
- "–Ø –≥–æ—Ç–æ–≤–∞" (–Ω–µ "–Ø –≥–æ—Ç–æ–≤–∏–π")
- "–Ø –±—É–ª–∞" (–Ω–µ "–Ø –±—É–≤")

–¢–≤—ñ–π —Å—Ç–∏–ª—å: –¥—Ä—É–∂–Ω—ñ–π, –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, —Ç—É—Ä–±–æ—Ç–ª–∏–≤–∏–π."""
}

ALEX_PERSONA = {
    "name": "Alex Gradus",
    "gender": "male",
    "platform": "web_consultant",
    "language": "ukrainian",
    
    # Ukrainian masculine forms
    "grammar": {
        # Present tense
        "glad": "—Ä–∞–¥",
        "ready": "–≥–æ—Ç–æ–≤–∏–π",
        "happy": "—â–∞—Å–ª–∏–≤–∏–π",
        
        # Past tense
        "was": "–±—É–≤",
        "helped": "–¥–æ–ø–æ–º—ñ–≥",
        
        # Adjectives
        "available": "–¥–æ—Å—Ç—É–ø–Ω–∏–π",
        "busy": "–∑–∞–π–Ω—è—Ç–∏–π",
    },
    
    # Common phrases
    "greetings": {
        "welcome": "–ü—Ä–∏–≤—ñ—Ç! üëã –†–∞–¥ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å!",
        "return": "–†–∞–¥ –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏!",
        "help": "–ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"
    },
    
    # System prompt
    "system_context": """–¢–∏ ‚Äî Alex Gradus, –µ–∫—Å–ø–µ—Ä—Ç –∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É —Ç–∞ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥—É –≤ HoReCa.
–¢–∏ ‚Äî —á–æ–ª–æ–≤—ñ–∫, —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —á–æ–ª–æ–≤—ñ—á—ñ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º–∏ –≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ–π –º–æ–≤—ñ:
- "–†–∞–¥ –¥–æ–ø–æ–º–æ–≥—Ç–∏" (–Ω–µ "–†–∞–¥–∞")
- "–Ø –≥–æ—Ç–æ–≤–∏–π" (–Ω–µ "–Ø –≥–æ—Ç–æ–≤–∞")
- "–Ø –±—É–≤" (–Ω–µ "–Ø –±—É–ª–∞")

–¢–≤—ñ–π —Å—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, –≤–ø–µ–≤–Ω–µ–Ω–∏–π, –µ–∫—Å–ø–µ—Ä—Ç–Ω–∏–π."""
}

def get_persona(agent_type: str) -> dict:
    """Get persona configuration by agent type."""
    if agent_type == "maya_hr":
        return MAYA_PERSONA
    elif agent_type == "alex_gradus":
        return ALEX_PERSONA
    else:
        raise ValueError(f"Unknown agent type: {agent_type}")
```

### Step 2: Update Maya HR System Prompt

**File:** `backend/services/hr_rag_service.py`

Find where Claude API is called and update system prompt:
```python
from config.agent_personas import MAYA_PERSONA

class HRRagService:
    
    async def call_claude_with_context(
        self,
        query: str,
        context: str,
        user_context: dict
    ) -> str:
        """Call Claude with Maya's female persona."""
        
        # Build system prompt with gender context
        system_prompt = f"""{MAYA_PERSONA['system_context']}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
- –Ü–º'—è: {user_context.get('full_name', '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}
- –ü–æ—Å–∞–¥–∞: {user_context.get('position', 'N/A')}

–ë–∞–∑–∞ –∑–Ω–∞–Ω—å:
{context}

–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø—Ä–∏—Ä–æ–¥–Ω–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∂—ñ–Ω–æ—á—ñ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º–∏.
"""
        
        # Call Claude
        response = await self.anthropic.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1000,
            system=system_prompt,
            messages=[{
                "role": "user",
                "content": query
            }]
        )
        
        answer = response.content[0].text
        
        # Validate gender (optional check)
        if self._contains_masculine_forms(answer):
            logger.warning(
                f"‚ö†Ô∏è GENDER_ERROR: Maya used masculine forms in answer: "
                f"'{answer[:100]}...'"
            )
        
        return answer
    
    def _contains_masculine_forms(self, text: str) -> bool:
        """Check if text contains masculine Ukrainian forms."""
        masculine_patterns = [
            r'\b—Ä–∞–¥\b',      # not —Ä–∞–¥–∞
            r'\b–≥–æ—Ç–æ–≤–∏–π\b',  # not –≥–æ—Ç–æ–≤–∞
            r'\b–±—É–≤\b',      # not –±—É–ª–∞
        ]
        
        import re
        for pattern in masculine_patterns:
            if re.search(pattern, text.lower()):
                return True
        return False
```

### Step 3: Update Maya's Hardcoded Messages

**File:** `backend/routes/telegram_webhook.py`

Replace ALL hardcoded messages with gender-correct versions:
```python
from config.agent_personas import MAYA_PERSONA

# Import helper
def maya_greeting(first_name: str, returning: bool = False) -> str:
    """Generate Maya's greeting with correct grammar."""
    if returning:
        return (
            f"–ü—Ä–∏–≤—ñ—Ç, {first_name}! üëã\n\n"
            f"{MAYA_PERSONA['greetings']['return']} "
            f"{MAYA_PERSONA['greetings']['help']}"
        )
    else:
        return (
            f"–ü—Ä–∏–≤—ñ—Ç, {first_name}! üëã\n\n"
            f"{MAYA_PERSONA['greetings']['welcome']} "
            f"{MAYA_PERSONA['greetings']['help']}"
        )

# Find and replace all greetings:

# Example 1: /start command
@router.command("start")
async def handle_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_data = await get_user_by_telegram_id(db, user.id)
    
    if user_data:
        # Returning user
        message = maya_greeting(user.first_name, returning=True)
    else:
        # New user
        message = (
            f"–ü—Ä–∏–≤—ñ—Ç, {user.first_name}! üëã\n\n"
            f"–Ø ‚Äî Maya, —Ç–≤—ñ–π HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç —É TD AV.\n\n"
            f"{MAYA_PERSONA['grammar']['glad']} –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å! "  # "–†–∞–¥–∞"
            f"–ù–∞–¥—ñ—à–ª–∏ —Å–≤—ñ–π —Ä–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó."
        )
    
    await update.message.reply_text(message)

# Example 2: After verification
await send_message(
    chat_id,
    f"‚úÖ –í—ñ—Ç–∞—é, {employee['full_name']}!\n\n"
    f"–í–∏ —É—Å–ø—ñ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.\n\n"
    f"–¢–µ–ø–µ—Ä {MAYA_PERSONA['grammar']['ready']} –¥–æ–ø–æ–º–æ–≥—Ç–∏ "  # "–≥–æ—Ç–æ–≤–∞"
    f"–∑ –±—É–¥—å-—è–∫–∏–º–∏ HR-–ø–∏—Ç–∞–Ω–Ω—è–º–∏! üí¨"
)

# Example 3: Authenticated user sends phone
await update.message.reply_text(
    f"‚úÖ –í–∏ –≤–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫ {user_data['full_name']}\n\n"
    f"–Ø {MAYA_PERSONA['grammar']['ready']} –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ HR-–ø–∏—Ç–∞–Ω–Ω—è–º–∏.\n\n"  # "–≥–æ—Ç–æ–≤–∞"
    f"–ê–±–æ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–Ω—à–∏–π –Ω–æ–º–µ—Ä:",
    reply_markup=keyboard
)
```

### Step 4: Update Alex Gradus System Prompt

**File:** `backend/routes/alex_routes.py`

Find where Alex's responses are generated:
```python
from config.agent_personas import ALEX_PERSONA

@router.post("/api/alex/ask")
async def alex_ask(request: AlexQueryRequest):
    """Alex Gradus consultation endpoint."""
    
    # Build system prompt with gender context
    system_prompt = f"""{ALEX_PERSONA['system_context']}

–ë–∞–∑–∞ –∑–Ω–∞–Ω—å:
{context}

–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø—Ä–∏—Ä–æ–¥–Ω–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —á–æ–ª–æ–≤—ñ—á—ñ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º–∏.
"""
    
    # Call Claude
    response = await anthropic.messages.create(
        model="claude-sonnet-4-20250514",
        system=system_prompt,
        messages=[{
            "role": "user",
            "content": request.query
        }]
    )
    
    return {"answer": response.content[0].text}
```

### Step 5: Add Gender Validation Tests

**File:** `backend/tests/test_personas.py` (NEW)
```python
import pytest
from config.agent_personas import MAYA_PERSONA, ALEX_PERSONA

def test_maya_uses_feminine_forms():
    """Ensure Maya's config has feminine Ukrainian grammar."""
    assert MAYA_PERSONA['grammar']['glad'] == '—Ä–∞–¥–∞'
    assert MAYA_PERSONA['grammar']['ready'] == '–≥–æ—Ç–æ–≤–∞'
    assert MAYA_PERSONA['grammar']['was'] == '–±—É–ª–∞'
    assert MAYA_PERSONA['gender'] == 'female'

def test_alex_uses_masculine_forms():
    """Ensure Alex's config has masculine Ukrainian grammar."""
    assert ALEX_PERSONA['grammar']['glad'] == '—Ä–∞–¥'
    assert ALEX_PERSONA['grammar']['ready'] == '–≥–æ—Ç–æ–≤–∏–π'
    assert ALEX_PERSONA['grammar']['was'] == '–±—É–≤'
    assert ALEX_PERSONA['gender'] == 'male'

def test_maya_greeting_feminine():
    """Maya's greetings use feminine forms."""
    greeting = MAYA_PERSONA['greetings']['welcome']
    assert '—Ä–∞–¥–∞' in greeting.lower() or '–†–∞–¥–∞' in greeting
    assert '—Ä–∞–¥' not in greeting.lower()  # No masculine

def test_alex_greeting_masculine():
    """Alex's greetings use masculine forms."""
    greeting = ALEX_PERSONA['greetings']['welcome']
    assert '—Ä–∞–¥' in greeting.lower() or '–†–∞–¥' in greeting
    assert '—Ä–∞–¥–∞' not in greeting.lower()  # No feminine
```

### Step 6: Search and Replace All Instances

Run these searches to find remaining issues:
```bash
# Find potential masculine forms in Maya's code
grep -rn "–†–∞–¥–∏–π\|—Ä–∞–¥–∏–π\|–ì–æ—Ç–æ–≤–∏–π\|–≥–æ—Ç–æ–≤–∏–π\|–ë—É–≤\|–±—É–≤" backend/routes/telegram_webhook.py backend/services/hr_rag_service.py

# Find potential feminine forms in Alex's code
grep -rn "–†–∞–¥–∞\|—Ä–∞–¥–∞\|–ì–æ—Ç–æ–≤–∞\|–≥–æ—Ç–æ–≤–∞\|–ë—É–ª–∞\|–±—É–ª–∞" backend/routes/alex_routes.py

# List all Ukrainian greeting patterns
grep -rn "–ü—Ä–∏–≤—ñ—Ç.*–¥–æ–ø–æ–º–æ–≥—Ç–∏\|–í—ñ—Ç–∞—é.*–¥–æ–ø–æ–º–æ–≥—Ç–∏" backend/
```

## TESTING CHECKLIST

### Maya HR (Telegram)
- [ ] `/start` ‚Üí "–†–∞–¥–∞ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å"
- [ ] After verification ‚Üí "–≥–æ—Ç–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏"
- [ ] Authenticated greeting ‚Üí "–†–∞–¥–∞ –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏"
- [ ] Claude responses ‚Üí Check for "—Ä–∞–¥–∞", "–≥–æ—Ç–æ–≤–∞" (not "—Ä–∞–¥", "–≥–æ—Ç–æ–≤–∏–π")

### Alex Gradus (Web)
- [ ] Initial greeting ‚Üí "–†–∞–¥ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—å"
- [ ] Consultation responses ‚Üí "–≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏"
- [ ] Claude responses ‚Üí Check for "—Ä–∞–¥", "–≥–æ—Ç–æ–≤–∏–π" (not "—Ä–∞–¥–∞", "–≥–æ—Ç–æ–≤–∞")

## MONITORING

Add logging to catch gender errors:
```python
# In both agents, after Claude response:
def validate_gender(agent_type: str, response_text: str):
    """Log if agent uses wrong gender."""
    
    if agent_type == "maya_hr":
        # Should be feminine
        wrong_patterns = ['\\b—Ä–∞–¥\\b', '\\b–≥–æ—Ç–æ–≤–∏–π\\b', '\\b–±—É–≤\\b']
        correct = "feminine"
    else:
        # Should be masculine
        wrong_patterns = ['\\b—Ä–∞–¥–∞\\b', '\\b–≥–æ—Ç–æ–≤–∞\\b', '\\b–±—É–ª–∞\\b']
        correct = "masculine"
    
    import re
    for pattern in wrong_patterns:
        if re.search(pattern, response_text, re.IGNORECASE):
            logger.warning(
                f"‚ö†Ô∏è GENDER_ERROR: {agent_type} used wrong gender. "
                f"Expected {correct}, found: '{response_text[:100]}...'"
            )
            break
```

## SUCCESS CRITERIA
- ‚úÖ Maya always uses feminine forms (—Ä–∞–¥–∞, –≥–æ—Ç–æ–≤–∞, –±—É–ª–∞)
- ‚úÖ Alex always uses masculine forms (—Ä–∞–¥, –≥–æ—Ç–æ–≤–∏–π, –±—É–≤)
- ‚úÖ System prompts enforce correct gender
- ‚úÖ Hardcoded messages use correct gender
- ‚úÖ Tests validate gender configuration
- ‚úÖ Monitoring logs gender mismatches