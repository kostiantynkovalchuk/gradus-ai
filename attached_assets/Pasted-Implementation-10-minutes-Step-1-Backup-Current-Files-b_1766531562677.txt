Implementation (10 minutes)
Step 1: Backup Current Files
bashcd ~/workspace/backend

# Backup in case we need to rollback
cp routes/telegram_webhook.py routes/telegram_webhook.py.backup
cp main.py main.py.backup

echo "‚úÖ Backups created"
Step 2: Replace routes/telegram_webhook.py
bashcat > routes/telegram_webhook.py << 'TELEGRAM_ROUTER_EOF'
"""
Unified Telegram Webhook Handler
Handles BOTH:
1. Approval callbacks (approve/reject buttons)
2. Maya bot chat messages
"""

from fastapi import APIRouter, Request, Depends
from sqlalchemy.orm import Session
import os
import httpx
import logging
from models import get_db
from services.telegram_webhook import telegram_webhook_handler

logger = logging.getLogger(__name__)
router = APIRouter()

TELEGRAM_MAYA_BOT_TOKEN = os.getenv("TELEGRAM_MAYA_BOT_TOKEN")


@router.post("/webhook")
async def handle_telegram_webhook(request: Request, db: Session = Depends(get_db)):
    """
    UNIFIED webhook handler for all Telegram updates
    
    Priority order:
    1. Callback queries (approval buttons) - Critical business logic
    2. Regular messages (Maya bot chat) - User interaction
    """
    
    try:
        data = await request.json()
        
        # Log for debugging
        logger.info(f"üìû Telegram webhook: {list(data.keys())}")
        
        # ========================================
        # PRIORITY 1: Approval Callbacks
        # ========================================
        if "callback_query" in data:
            callback_data = data['callback_query'].get('data', '')
            logger.info(f"üîò Callback query: {callback_data}")
            
            # Use existing approval handler
            result = telegram_webhook_handler.handle_callback_query(
                data['callback_query'],
                db
            )
            
            logger.info(f"‚úì Callback processed: {result.get('status')}")
            return result
        
        # ========================================
        # PRIORITY 2: Maya Bot Messages
        # ========================================
        elif "message" in data:
            message = data["message"]
            text = message.get("text", "")
            logger.info(f"üí¨ Message from user: {text[:50]}")
            
            await process_telegram_message(message)
            return {"ok": True}
        
        # ========================================
        # Unknown Update Type
        # ========================================
        else:
            logger.warning(f"‚ö†Ô∏è  Unknown update: {list(data.keys())}")
            return {"ok": True}
            
    except Exception as e:
        logger.error(f"‚ùå Webhook error: {e}", exc_info=True)
        return {"ok": False, "error": str(e)}


async def process_telegram_message(message: dict):
    """Process Maya bot chat messages"""
    try:
        chat_id = message.get("chat", {}).get("id")
        text = message.get("text", "")
        user_name = message.get("from", {}).get("first_name", "Friend")
        
        if not text or not chat_id:
            return
        
        # Handle commands
        if text.startswith("/"):
            if text == "/start":
                await send_telegram_message(
                    chat_id,
                    "–ü—Ä–∏–≤—ñ—Ç! –Ø Maya üëã\n\n"
                    "AI-–µ–∫—Å–ø–µ—Ä—Ç–∫–∞ –∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É —Ç–∞ —Ç—Ä–µ–Ω–¥—ñ–≤ –∞–ª–∫–æ–≥–æ–ª—å–Ω–æ—ó —ñ–Ω–¥—É—Å—Ç—Ä—ñ—ó –≤—ñ–¥ Gradus Media.\n\n"
                    "–ó–∞–ø–∏—Ç–∞–π –º–µ–Ω–µ –ø—Ä–æ:\n"
                    "üç∏ –ë—Ä–µ–Ω–¥–∏ –≥–æ—Ä—ñ–ª–∫–∏, –∫–æ–Ω—å—è–∫—É, –≤–∏–Ω–∞\n"
                    "üçπ –ö–æ–∫—Ç–µ–π–ª—ñ —Ç–∞ —Ä–µ—Ü–µ–ø—Ç–∏\n"
                    "üìä –¢—Ä–µ–Ω–¥–∏ —Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥\n\n"
                    "–Ø –∑–∞–≤–∂–¥–∏ —Ä–∞–¥–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏!"
                )
            elif text == "/help":
                await send_telegram_message(
                    chat_id,
                    "–Ø Maya - –≤–∞—à AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –∞–ª–∫–æ–≥–æ–ª—å–Ω–æ—ó —ñ–Ω–¥—É—Å—Ç—Ä—ñ—ó! ü•Ç\n\n"
                    "–ú–æ–∂—É —Ä–æ–∑–ø–æ–≤—ñ—Å—Ç–∏ –ø—Ä–æ:\n"
                    "‚Ä¢ –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –±—Ä–µ–Ω–¥–∏: GreenDay, Dovbush, Villa.ua\n"
                    "‚Ä¢ –°–≤—ñ—Ç–æ–≤—ñ —Ç—Ä–µ–Ω–¥–∏ –∞–ª–∫–æ–≥–æ–ª—å–Ω–æ–≥–æ —Ä–∏–Ω–∫—É\n"
                    "‚Ä¢ –ö–æ–∫—Ç–µ–π–ª—ñ —Ç–∞ —Ä–µ—Ü–µ–ø—Ç–∏\n"
                    "‚Ä¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó\n\n"
                    "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è!"
                )
            return
        
        # Handle regular messages
        # TODO: Integrate with Claude/Maya AI chat service
        await send_telegram_message(
            chat_id,
            f"–ü—Ä–∏–≤—ñ—Ç, {user_name}! üëã\n\n"
            f"–û—Ç—Ä–∏–º–∞–ª–∞ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:\n<i>'{text}'</i>\n\n"
            "–§—É–Ω–∫—Ü—ñ—è —á–∞—Ç—É –∑ Maya –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ. –°–∫–æ—Ä–æ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞! üöÄ"
        )
            
    except Exception as e:
        logger.error(f"Error processing message: {e}", exc_info=True)


async def send_telegram_message(chat_id: int, text: str):
    """Send message via Maya bot"""
    if not TELEGRAM_MAYA_BOT_TOKEN:
        logger.error("TELEGRAM_MAYA_BOT_TOKEN not set")
        return
    
    url = f"https://api.telegram.org/bot{TELEGRAM_MAYA_BOT_TOKEN}/sendMessage"
    
    async with httpx.AsyncClient() as client:
        try:
            response = await client.post(
                url,
                json={
                    "chat_id": chat_id,
                    "text": text,
                    "parse_mode": "HTML"
                },
                timeout=10.0
            )
            
            if response.status_code == 200:
                logger.info(f"‚úì Message sent to chat {chat_id}")
            else:
                logger.error(f"Telegram API error: {response.text}")
                
        except Exception as e:
            logger.error(f"Error sending message: {e}")
TELEGRAM_ROUTER_EOF

echo "‚úÖ routes/telegram_webhook.py updated"
Step 3: Update main.py - Uncomment Router
bash# Uncomment the router import and registration (lines 188-189)
sed -i '188s/^# //' main.py
sed -i '189s/^# //' main.py

echo "‚úÖ Router enabled in main.py"
Step 4: Update main.py - Remove Duplicate Function
bash# Find the duplicate function
LINE_NUM=$(grep -n "^@app.post(\"/api/telegram/webhook\")" main.py | cut -d: -f1)

if [ -n "$LINE_NUM" ]; then
    echo "Found duplicate function at line $LINE_NUM"
    
    # Calculate end line (function is ~30 lines)
    END_LINE=$((LINE_NUM + 30))
    
    # Delete the duplicate function
    sed -i "${LINE_NUM},${END_LINE}d" main.py
    
    echo "‚úÖ Duplicate function removed from main.py"
else
    echo "‚ÑπÔ∏è  No duplicate function found (already removed or different location)"
fi
Step 5: Verify Changes
bashecho "================================"
echo "Verification"
echo "================================"

# Check router is enabled
echo "1. Router registration:"
grep -A1 "from routes.telegram_webhook import" main.py | head -2

echo ""
echo "2. No duplicate @app.post('/api/telegram/webhook'):"
if grep -q "^@app.post(\"/api/telegram/webhook\")" main.py; then
    echo "   ‚ùå DUPLICATE STILL EXISTS!"
else
    echo "   ‚úÖ No duplicate found"
fi

echo ""
echo "3. Unified webhook file exists:"
if [ -f "routes/telegram_webhook.py" ]; then
    echo "   ‚úÖ routes/telegram_webhook.py exists"
    
    # Check it has the unified handler
    if grep -q "PRIORITY 1: Approval Callbacks" routes/telegram_webhook.py; then
        echo "   ‚úÖ Contains unified handler"
    else
        echo "   ‚ùå Missing unified handler logic"
    fi
else
    echo "   ‚ùå File not found!"
fi
Step 6: Test in Replit
bash# Verify routes are correct
python << 'VERIFY_EOF'
import sys
sys.path.insert(0, 'backend')

# Force reload
for mod in list(sys.modules.keys()):
    if 'main' in mod or 'routes' in mod or 'services' in mod:
        del sys.modules[mod]

from main import app

print("\n" + "="*60)
print("Route Check")
print("="*60)

telegram_routes = [r for r in app.routes if 'telegram' in r.path.lower()]

for route in telegram_routes:
    if hasattr(route, 'methods'):
        print(f"{route.path:40} {list(route.methods)} -> {route.name}")

webhook_count = len([r for r in app.routes if r.path == '/api/telegram/webhook'])

print("\n" + "="*60)
if webhook_count == 1:
    print("‚úÖ PERFECT! Only 1 webhook route")
    print("üéØ Ready to deploy and test!")
elif webhook_count == 0:
    print("‚ùå ERROR: No webhook route found!")
else:
    print(f"‚ùå ERROR: {webhook_count} webhook routes (should be 1)")
print("="*60)
VERIFY_EOF
Step 7: Commit and Deploy
bashcd ~/workspace

git add backend/routes/telegram_webhook.py backend/main.py
git commit -m "feat: Unified Telegram webhook for approvals + Maya chat"
git push origin main

echo ""
echo "================================"
echo "üöÄ Pushed to Render!"
echo "================================"
echo ""
echo "Next steps:"
echo "1. Wait 30-60 seconds for Render to deploy"
echo "2. Check Render logs for 'Deploy succeeded'"
echo "3. Test approval callback in Telegram"
echo "4. Test Maya bot by sending /start"
