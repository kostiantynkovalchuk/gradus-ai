# URGENT: Fix Phone Number Format Inconsistency in Auth System

## PROBLEM
Employee phone numbers in Blitz/SED are stored in different formats, but we can't change SED's data. We need to try multiple formats when querying.

## SOLUTION
When verifying a phone number:
1. Normalize user input to standard format
2. Generate multiple format variations
3. Try each variation against SED API
4. Return employee data when ANY format matches

---

## IMPLEMENTATION

### File: `backend/utils/phone_normalizer.py`
```python
"""Phone number normalization and format generation for Ukrainian numbers."""

import re
import logging

logger = logging.getLogger(__name__)


def normalize_phone(phone: str) -> str:
    """
    Normalize Ukrainian phone to: 380XXXXXXXXX (12 digits)
    
    Handles:
    - +380XXXXXXXXX ‚Üí 380XXXXXXXXX
    - 0XXXXXXXXX ‚Üí 380XXXXXXXXX
    - 380XXXXXXXXX ‚Üí 380XXXXXXXXX
    - +38 095 690 02 89 ‚Üí 380956900289
    """
    
    if not phone:
        raise ValueError("Phone number is empty")
    
    # Remove all non-digit characters
    digits_only = re.sub(r'\D', '', phone)
    
    # Handle different input formats
    if digits_only.startswith('380'):
        normalized = digits_only
    elif digits_only.startswith('0'):
        normalized = '380' + digits_only[1:]
    elif digits_only.startswith('80'):
        normalized = '3' + digits_only
    else:
        normalized = '380' + digits_only
    
    # Validate
    if len(normalized) != 12:
        raise ValueError(f"Invalid phone: {phone} (expected 12 digits)")
    
    if not normalized.startswith('380'):
        raise ValueError(f"Invalid phone: {phone} (must be Ukrainian +380)")
    
    logger.debug(f"Normalized: {phone} ‚Üí {normalized}")
    return normalized


def generate_format_variations(phone_normalized: str) -> list:
    """
    Generate all possible phone format variations for SED API queries.
    
    Args:
        phone_normalized: Normalized phone (380XXXXXXXXX)
    
    Returns:
        List of format variations to try:
        - 380956900289
        - +380956900289
        - 0956900289
        - +380 95 690 02 89
    """
    
    if len(phone_normalized) != 12:
        raise ValueError("Phone must be normalized first (12 digits)")
    
    local_digits = phone_normalized[3:]  # Remove 380 prefix
    
    variations = [
        phone_normalized,                    # 380956900289
        f"+{phone_normalized}",              # +380956900289
        f"0{local_digits}",                  # 0956900289
        f"+380 {local_digits[0:2]} {local_digits[2:5]} {local_digits[5:7]} {local_digits[7:9]}",  # +380 95 690 02 89
        f"380 {local_digits[0:2]} {local_digits[2:5]} {local_digits[5:7]} {local_digits[7:9]}",   # 380 95 690 02 89
    ]
    
    logger.debug(f"Generated {len(variations)} format variations for {phone_normalized}")
    return variations


def format_for_display(phone_normalized: str) -> str:
    """Format phone for display: +380 XX XXX XX XX"""
    
    if len(phone_normalized) != 12:
        return phone_normalized
    
    digits = phone_normalized[3:]  # Remove 380
    return f"+380 {digits[0:2]} {digits[2:5]} {digits[5:7]} {digits[7:9]}"
```

---

### File: `backend/services/hr_sed_service.py`

Update SED API integration to try multiple formats:
```python
from utils.phone_normalizer import normalize_phone, generate_format_variations
import httpx
import logging

logger = logging.getLogger(__name__)


async def verify_employee_in_sed(phone: str) -> dict:
    """
    Verify employee in SED by trying multiple phone format variations.
    
    SED stores phones in different formats, so we try all possibilities:
    - 380956900289
    - +380956900289
    - 0956900289
    - etc.
    
    Args:
        phone: User's phone number (any format)
    
    Returns:
        Employee data if found in SED, None otherwise
    """
    
    try:
        # Normalize user input
        phone_normalized = normalize_phone(phone)
        logger.info(f"Verifying employee: {phone} ‚Üí {phone_normalized}")
        
        # Generate format variations
        formats = generate_format_variations(phone_normalized)
        
        # Try each format
        for i, format_attempt in enumerate(formats, 1):
            try:
                logger.debug(f"Attempt {i}/{len(formats)}: Trying format '{format_attempt}'")
                
                response = await httpx.post(
                    f"{SED_API_URL}/api/employees",
                    headers={
                        "X-API-Key": SED_API_KEY,
                        "Content-Type": "application/json"
                    },
                    json={"phone": format_attempt},
                    timeout=5.0
                )
                
                # Check response
                if response.status_code == 200:
                    employee_data = response.json()
                    logger.info(
                        f"‚úÖ Employee found with format '{format_attempt}': "
                        f"{employee_data.get('full_name', 'Unknown')}"
                    )
                    
                    # Add normalized phone to response
                    employee_data['phone_normalized'] = phone_normalized
                    employee_data['phone_format_used'] = format_attempt
                    
                    return employee_data
                
                elif response.status_code == 401:
                    logger.error(f"SED API 401 Unauthorized (invalid API key)")
                    raise Exception("SED API key invalid or expired")
                
                elif response.status_code == 404:
                    logger.debug(f"Format '{format_attempt}' not found, trying next...")
                    continue
                
                else:
                    logger.warning(f"SED API returned {response.status_code}")
                    continue
                    
            except httpx.TimeoutException:
                logger.warning(f"SED API timeout for format '{format_attempt}'")
                continue
                
            except Exception as e:
                logger.error(f"Error trying format '{format_attempt}': {e}")
                continue
        
        # None of the formats worked
        logger.warning(
            f"‚ùå Employee not found with ANY format variation. "
            f"Phone: {phone_normalized}, Tried {len(formats)} formats"
        )
        return None
        
    except ValueError as e:
        logger.error(f"Invalid phone format: {phone} - {e}")
        raise
        
    except Exception as e:
        logger.error(f"SED API error: {e}")
        raise
```

---

### File: `backend/routes/telegram_webhook.py`

Update user prompts to accept any format:
```python
from utils.phone_normalizer import normalize_phone, format_for_display

async def handle_phone_verification(update, context):
    """
    Handle phone number submission.
    Accepts ANY format - system tries all variations with SED.
    """
    
    phone_input = update.message.text.strip()
    
    try:
        # Normalize phone
        phone_normalized = normalize_phone(phone_input)
        phone_display = format_for_display(phone_normalized)
        
        # Show user what we're checking
        await update.message.reply_text(
            f"üìû –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–æ–º–µ—Ä: {phone_display}\n"
            f"‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ..."
        )
        
        # Verify in SED (tries multiple formats automatically)
        employee_data = await verify_employee_in_sed(phone_normalized)
        
        if employee_data:
            # Success!
            await register_user(
                telegram_id=update.effective_user.id,
                phone_normalized=phone_normalized,
                employee_data=employee_data
            )
            
            await update.message.reply_text(
                f"‚úÖ –í—ñ—Ç–∞—é, {employee_data['full_name']}!\n"
                f"–í–∏ —É—Å–ø—ñ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫ {employee_data['position']}."
            )
            
            logger.info(
                f"‚úÖ User verified: {employee_data['full_name']} "
                f"(format used: {employee_data['phone_format_used']})"
            )
        else:
            # Not found in SED
            await update.message.reply_text(
                f"‚ùå –ù–æ–º–µ—Ä {phone_display} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ TD AV.\n\n"
                f"–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n"
                f"‚Ä¢ –í–∏ —â–µ –Ω–µ –≤ —Å–∏—Å—Ç–µ–º—ñ –ë–ª—ñ—Ü\n"
                f"‚Ä¢ –ù–æ–º–µ—Ä –≤–∫–∞–∑–∞–Ω–æ –Ω–µ–≤—ñ—Ä–Ω–æ\n\n"
                f"üìû –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ HR-–≤—ñ–¥–¥—ñ–ª—É:\n"
                f"–ù–∞—Ç–∞–ª—ñ—è –†–µ—à–µ—Ç—ñ–ª–æ–≤–∞\n"
                f"hr@vinkom.net"
            )
            
            # Notify HR admins
            await notify_hr_admins_failed_verification(
                phone_display,
                update.effective_user
            )
        
    except ValueError as e:
        # Invalid phone format
        await update.message.reply_text(
            f"‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞.\n\n"
            f"üì± –í–≤–µ–¥—ñ—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –Ω–æ–º–µ—Ä —É –±—É–¥—å-—è–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ:\n"
            f"‚úÖ +380956900289\n"
            f"‚úÖ 0956900289\n"
            f"‚úÖ 380956900289\n\n"
            f"–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:"
        )


async def send_phone_prompt(update, context):
    """Send phone verification prompt to user."""
    
    await update.message.reply_text(
        "üëã –í—ñ—Ç–∞—é! –Ø Maya, HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç –¢–æ—Ä–≥–æ–≤–æ–≥–æ –î–æ–º—É –ê–í.\n\n"
        "üìû –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:\n\n"
        "–ë—É–¥—å-—è–∫–∏–π —Ñ–æ—Ä–º–∞—Ç:\n"
        "‚úÖ +380956900289\n"
        "‚úÖ 0956900289\n"
        "‚úÖ 380 95 690 02 89\n\n"
        "–í–∞—à –Ω–æ–º–µ—Ä:"
    )
```

---

## TESTING

Test that all format combinations work:
```python
# Test cases
test_cases = [
    # (User input, SED has, Should match)
    ("+380956900289", "0956900289", True),
    ("0956900289", "+380956900289", True),
    ("380956900289", "0956900289", True),
    ("+38 095 690 02 89", "380956900289", True),
    ("095-690-02-89", "+380 95 690 02 89", True),
]

for user_input, sed_format, should_match in test_cases:
    result = await verify_employee_in_sed(user_input)
    assert (result is not None) == should_match
```

---

## KEY POINTS

1. ‚úÖ We DON'T modify SED data (we can't!)
2. ‚úÖ We normalize USER input
3. ‚úÖ We generate MULTIPLE format variations
4. ‚úÖ We TRY each variation with SED API
5. ‚úÖ We return success when ANY variation matches

This is a "brute force" approach that tries all possibilities until one works!

---

Implement this version - it's the correct solution for read-only SED access.
```

---

**üí° TL;DR:**

**Wrong approach:** "Normalize SED data" ‚ùå (we can't access it!)

**Right approach:** "Try multiple formats when querying SED" ‚úÖ (we CAN do this!)
```
User: +380956900289
       ‚Üì
Try: 380956900289 ‚Üí SED says "not found"
Try: +380956900289 ‚Üí SED says "not found"  
Try: 0956900289 ‚Üí SED says "‚úÖ FOUND!"
       ‚Üì
Success! ‚úÖ