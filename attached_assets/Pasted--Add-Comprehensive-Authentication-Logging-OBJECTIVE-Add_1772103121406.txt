# Add Comprehensive Authentication Logging

## OBJECTIVE
Add detailed logging to distinguish between:
1. User not found in database (needs verification)
2. Database connection errors (technical issue)
3. User found but inactive (edge case)
4. User found and active (success)

This will help diagnose authentication issues like Vasile's case.

## PROBLEM
Current code doesn't distinguish between "user not in database" vs "database error":
```python
user = await get_user_by_telegram_id(telegram_id)
if not user:
    # Could mean: not found OR database crashed OR connection timeout
    # We don't know which!
```

## SOLUTION

### Step 1: Update User Lookup Function

**File:** `backend/services/hr_auth.py` (or wherever `get_user_by_telegram_id` is defined)
```python
import logging
from typing import Optional, Dict

logger = logging.getLogger(__name__)

async def get_user_by_telegram_id(
    db,
    telegram_id: int
) -> Optional[Dict]:
    """
    Get user from database with detailed logging.
    
    Returns:
        User dict if found and active
        None if not found or inactive
        
    Logs:
        - Database errors (connection, timeout, etc.)
        - User not found
        - User found but inactive
        - User found and active
    """
    try:
        logger.debug(f"üîç Looking up user: telegram_id={telegram_id}")
        
        # Query database
        result = await db.execute(
            text("""
                SELECT 
                    telegram_id, full_name, phone, position, 
                    department, is_active, verification_method,
                    created_at, updated_at
                FROM hr_users
                WHERE telegram_id = :telegram_id
            """),
            {"telegram_id": telegram_id}
        )
        
        row = result.fetchone()
        
        if not row:
            # User genuinely not in database
            logger.info(f"‚ùå User not found: telegram_id={telegram_id}")
            return None
        
        user = dict(row._mapping)
        
        # Check if active
        if not user.get('is_active', False):
            logger.warning(
                f"‚ö†Ô∏è User found but INACTIVE: telegram_id={telegram_id}, "
                f"name={user.get('full_name', 'Unknown')}"
            )
            return None
        
        # Success - user found and active
        logger.info(
            f"‚úÖ User authenticated: telegram_id={telegram_id}, "
            f"name={user['full_name']}, "
            f"position={user.get('position', 'N/A')}"
        )
        
        return user
        
    except asyncio.TimeoutError:
        logger.error(
            f"‚è±Ô∏è DATABASE TIMEOUT: Failed to lookup user {telegram_id}. "
            f"Database is slow or unreachable."
        )
        return None
        
    except OperationalError as e:
        logger.error(
            f"üí• DATABASE CONNECTION ERROR: telegram_id={telegram_id}. "
            f"Error: {str(e)[:200]}"
        )
        return None
        
    except Exception as e:
        logger.error(
            f"üí• UNEXPECTED ERROR in get_user_by_telegram_id: "
            f"telegram_id={telegram_id}, "
            f"error_type={type(e).__name__}, "
            f"error={str(e)[:200]}",
            exc_info=True
        )
        return None
```

### Step 2: Update Message Handler Logging

**File:** `backend/routes/telegram_webhook.py`

Find the message handler that checks authentication, and update it:
```python
@router.message(F.text & ~F.command())
async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Route user messages with detailed auth logging."""
    
    user = update.effective_user
    telegram_id = user.id
    message_text = update.message.text.strip()
    
    logger.info(
        f"üì® Message received: telegram_id={telegram_id}, "
        f"username={user.username or 'None'}, "
        f"text='{message_text[:50]}...'"
    )
    
    # Check authentication with detailed logging
    try:
        user_data = await get_user_by_telegram_id(db, telegram_id)
        
        if not user_data:
            # User not authenticated
            # (Could be: not found, inactive, or database error - check logs above)
            
            logger.info(
                f"üö´ Unauthenticated user: telegram_id={telegram_id}. "
                f"Triggering verification flow."
            )
            
            # Detect if phone number
            if is_phone_number(message_text):
                # Phone number flow
                logger.info(f"üì± Phone detected: {message_text}")
                # ... existing phone confirmation logic ...
            else:
                # Prompt for verification
                logger.info(f"üí¨ Prompting unauthenticated user for phone")
                # ... existing prompt logic ...
            
            return
        
        # User authenticated - route to HR service
        logger.info(
            f"‚úÖ Authenticated user message: telegram_id={telegram_id}, "
            f"user={user_data['full_name']}, "
            f"routing to HR service"
        )
        
        # ... existing HR RAG service logic ...
        
    except Exception as e:
        logger.error(
            f"üí• CRITICAL ERROR in message handler: "
            f"telegram_id={telegram_id}, "
            f"error={str(e)[:200]}",
            exc_info=True
        )
        
        await update.message.reply_text(
            "‚ùå –í–∏–±–∞—á—Ç–µ, –≤–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞.\n\n"
            "–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ HR-–≤—ñ–¥–¥—ñ–ª—É."
        )
```

### Step 3: Add Database Health Check to Scheduler

**File:** `backend/services/scheduler.py`

Add a simple database health check that runs periodically:
```python
from services.database import db
from sqlalchemy import text
import logging

logger = logging.getLogger(__name__)

async def check_database_health():
    """
    Periodic database health check.
    Helps catch connection issues before they affect users.
    """
    try:
        # Simple query to test connection
        result = await db.execute(text("SELECT 1"))
        row = result.fetchone()
        
        if row and row[0] == 1:
            logger.info("‚úÖ Database health check: OK")
            return True
        else:
            logger.error("‚ùå Database health check: Unexpected result")
            return False
            
    except asyncio.TimeoutError:
        logger.error("‚è±Ô∏è Database health check: TIMEOUT - database is slow")
        return False
        
    except OperationalError as e:
        logger.error(f"üí• Database health check: CONNECTION ERROR - {str(e)[:200]}")
        return False
        
    except Exception as e:
        logger.error(
            f"üí• Database health check: UNEXPECTED ERROR - "
            f"{type(e).__name__}: {str(e)[:200]}"
        )
        return False

# Add to scheduler (runs every 5 minutes)
scheduler.add_job(
    check_database_health,
    'interval',
    minutes=5,
    id='database_health_check',
    name='Database Health Check'
)
```

### Step 4: Add Verification Attempt Logging

**File:** `backend/services/hr_auth.py`

In the phone verification flow, add detailed logging:
```python
async def handle_phone_verification(
    telegram_id: int,
    phone: str,
    chat_id: int
):
    """
    Verify phone with detailed logging.
    """
    
    logger.info(
        f"üîê VERIFICATION ATTEMPT: telegram_id={telegram_id}, "
        f"phone={phone[:4]}***{phone[-4:]}"
    )
    
    try:
        # Normalize phone
        phone_normalized = normalize_phone(phone)
        
        logger.debug(f"üìû Phone normalized: {phone} ‚Üí {phone_normalized}")
        
        # Check whitelist
        whitelisted = await is_phone_whitelisted(db, phone_normalized)
        
        if whitelisted:
            logger.info(
                f"‚úÖ WHITELIST HIT: phone={phone_normalized}, "
                f"telegram_id={telegram_id}"
            )
            # ... whitelist logic ...
            return
        
        # Call SED API
        logger.info(f"üîç Calling SED API: phone={phone_normalized}")
        
        employee = await verify_employee_in_sed(phone)
        
        if employee:
            logger.info(
                f"‚úÖ SED API SUCCESS: phone={phone_normalized}, "
                f"employee={employee.get('full_name', 'Unknown')}, "
                f"position={employee.get('position', 'N/A')}"
            )
            
            # Save to database
            await save_verified_user(telegram_id, employee)
            
            logger.info(
                f"üíæ USER SAVED: telegram_id={telegram_id}, "
                f"name={employee['full_name']}"
            )
            
        else:
            logger.warning(
                f"‚ùå SED API NOT FOUND: phone={phone_normalized}, "
                f"telegram_id={telegram_id}"
            )
            
    except Exception as e:
        logger.error(
            f"üí• VERIFICATION ERROR: telegram_id={telegram_id}, "
            f"phone={phone_normalized}, "
            f"error={str(e)[:200]}",
            exc_info=True
        )
        raise
```

## EXPECTED LOG OUTPUT

### Scenario 1: Normal Authentication (Success)
```
üîç Looking up user: telegram_id=892547382
‚úÖ User authenticated: telegram_id=892547382, name=–ü—Ä–æ—Ñ–∏—Ä –í–∞—Å–∏–ª–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á, position=Marketing Director
üì® Message received: telegram_id=892547382, username=vasile_rotaru, text='–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?...'
‚úÖ Authenticated user message: telegram_id=892547382, user=–ü—Ä–æ—Ñ–∏—Ä –í–∞—Å–∏–ª–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á, routing to HR service
```

### Scenario 2: User Not Found (Needs Verification)
```
üîç Looking up user: telegram_id=999999999
‚ùå User not found: telegram_id=999999999
üì® Message received: telegram_id=999999999, username=new_user, text='+380501234567...'
üö´ Unauthenticated user: telegram_id=999999999. Triggering verification flow.
üì± Phone detected: +380501234567
```

### Scenario 3: Database Connection Error
```
üîç Looking up user: telegram_id=892547382
üí• DATABASE CONNECTION ERROR: telegram_id=892547382. Error: connection to server at "..." failed
üì® Message received: telegram_id=892547382, username=vasile_rotaru, text='–Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –±–ª—ñ—Ü?...'
üö´ Unauthenticated user: telegram_id=892547382. Triggering verification flow.
‚ö†Ô∏è NOTE: User may actually be verified - database connection issue!
```

### Scenario 4: User Inactive
```
üîç Looking up user: telegram_id=892547382
‚ö†Ô∏è User found but INACTIVE: telegram_id=892547382, name=–ü—Ä–æ—Ñ–∏—Ä –í–∞—Å–∏–ª–∏–π –ú–∏—Ö–∞–π–ª–æ–≤–∏—á
üì® Message received: telegram_id=892547382, username=vasile_rotaru, text='...'
üö´ Unauthenticated user: telegram_id=892547382. Triggering verification flow.
```

### Scenario 5: Database Timeout
```
üîç Looking up user: telegram_id=892547382
‚è±Ô∏è DATABASE TIMEOUT: Failed to lookup user 892547382. Database is slow or unreachable.
‚ùå Database health check: TIMEOUT - database is slow
```

## TESTING

After implementation, test each scenario:
```bash
# 1. Normal auth (existing user sends message)
# Expected logs: "‚úÖ User authenticated" ‚Üí "‚úÖ Authenticated user message"

# 2. New user sends phone
# Expected logs: "‚ùå User not found" ‚Üí "üö´ Unauthenticated" ‚Üí "üì± Phone detected"

# 3. Simulate database issue (temporarily stop database)
# Expected logs: "üí• DATABASE CONNECTION ERROR" ‚Üí Health check fails

# 4. Set user to inactive in DB
UPDATE hr_users SET is_active = false WHERE telegram_id = 892547382;
# Expected logs: "‚ö†Ô∏è User found but INACTIVE"
```

## SUCCESS CRITERIA

After implementation:
- ‚úÖ Can distinguish "user not found" from "database error" in logs
- ‚úÖ Database health is monitored automatically
- ‚úÖ Every authentication attempt is logged with outcome
- ‚úÖ Errors include telegram_id, username, and error details
- ‚úÖ Can diagnose issues like Vasile's case from logs alone

## MONITORING

Watch logs for these patterns:

**Red flags (need action):**
```
üí• DATABASE CONNECTION ERROR (appears frequently)
‚è±Ô∏è DATABASE TIMEOUT (appears frequently)
‚ùå Database health check: TIMEOUT
```

**Normal operations:**
```
‚úÖ User authenticated (many per day)
‚ùå User not found (new employees)
‚úÖ Database health check: OK (every 5 min)
```

**Edge cases (investigate):**
```
‚ö†Ô∏è User found but INACTIVE (shouldn't happen often)
üö´ Unauthenticated user: telegram_id=892547382 (Vasile being prompted again)
```