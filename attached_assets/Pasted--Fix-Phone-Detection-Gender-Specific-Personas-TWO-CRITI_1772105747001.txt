# Fix: Phone Detection + Gender-Specific Personas

## TWO CRITICAL ISSUES

### Issue 1: Authenticated users sending phone numbers get "not found"
- User is verified ‚Üí sends phone number ‚Üí routed to HR RAG ‚Üí confusing error
- Need to detect phone numbers and show helpful message

### Issue 2: Maya uses wrong grammatical gender
- Maya is female but uses masculine Ukrainian forms
- "–†–∞–¥–∏–π" (masculine) should be "–†–∞–¥–∞" (feminine)

## SOLUTION: Implement Both Fixes

---

## PART 1: Add Phone Detection for Authenticated Users

### File: `backend/routes/telegram_webhook.py`

Find the section where authenticated users' messages are routed to HR RAG service.

Look for code like:
```python
# USER IS AUTHENTICATED
user_data = await get_user_by_telegram_id(db, telegram_id)

if user_data and user_data.get('is_active'):
    # Route to HR RAG
    logger.info(f"MSG_ROUTED: telegram_id={telegram_id}...")
```

**Add phone detection BEFORE routing to HR RAG:**
```python
# USER IS AUTHENTICATED
user_data = await get_user_by_telegram_id(db, telegram_id)

if user_data and user_data.get('is_active'):
    logger.info(
        f"‚úÖ Authenticated: telegram_id={telegram_id}, "
        f"user={user_data['full_name']}"
    )
    
    # CHECK IF MESSAGE IS A PHONE NUMBER
    if is_phone_number(message_text):
        logger.info(
            f"üì± AUTH_USER_SENT_PHONE: telegram_id={telegram_id}, "
            f"current_user={user_data['full_name']}, "
            f"phone={message_text[:7]}***"
        )
        
        # Show helpful message instead of treating as HR question
        keyboard = [
            [InlineKeyboardButton(
                text="üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü–µ–π –Ω–æ–º–µ—Ä",
                callback_data="hr_reverify:confirm"
            )],
            [InlineKeyboardButton(
                text="üìã HR –º–µ–Ω—é",
                callback_data="hr_menu:main"
            )]
        ]
        
        # Store phone for potential reverification
        context.user_data['reverify_phone'] = message_text
        
        await update.message.reply_text(
            f"‚úÖ –í–∏ –≤–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫ *{user_data['full_name']}*\n"
            f"üìã {user_data.get('position', 'N/A')}\n\n"
            f"üì± –í–∏ –Ω–∞–¥—ñ—Å–ª–∞–ª–∏ –Ω–æ–º–µ—Ä: `{message_text}`\n\n"
            f"–©–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏?",
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )
        
        return  # IMPORTANT: Don't route to HR RAG!
    
    # Not a phone number - continue to HR RAG
    logger.info(f"MSG_ROUTED: telegram_id={telegram_id}, text='{message_text[:50]}...'")
    
    # ... existing HR RAG routing code ...
```

### Add reverification callback handler

In the callback query handler, add support for `hr_reverify:confirm`:
```python
@router.callback_query()
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button clicks."""
    
    query = update.callback_query
    await query.answer()
    
    callback_data = query.data
    telegram_id = query.from_user.id
    
    # ... existing handlers ...
    
    # REVERIFICATION HANDLER (NEW)
    if callback_data == "hr_reverify:confirm":
        phone = context.user_data.get('reverify_phone')
        
        if not phone:
            await query.answer(
                "‚ùå –°–µ—Å—ñ—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞. –ù–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–º–µ—Ä —â–µ —Ä–∞–∑.",
                show_alert=True
            )
            return
        
        # Get current user
        current_user = await get_user_by_telegram_id(db, telegram_id)
        
        # Show loading message
        await query.message.edit_text(
            f"üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–æ–º–µ—Ä {phone}...\n\n"
            f"‚ö†Ô∏è –ü–æ—Ç–æ—á–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è:\n"
            f"‚Ä¢ {current_user['full_name']}\n"
            f"‚Ä¢ {current_user.get('position', 'N/A')}"
        )
        
        try:
            # Verify phone with SED
            from services.hr_sed_service import verify_employee_in_sed
            
            employee = await verify_employee_in_sed(phone)
            
            if employee:
                # Check if same person
                if employee.get('employee_id') == current_user.get('employee_id'):
                    # Same person
                    await query.message.edit_text(
                        f"‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!\n\n"
                        f"–¶–µ –≤–∞—à –ø–æ—Ç–æ—á–Ω–∏–π –Ω–æ–º–µ—Ä:\n"
                        f"‚Ä¢ {employee['full_name']}\n"
                        f"‚Ä¢ {employee.get('position', 'N/A')}\n\n"
                        f"–í—Å–µ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω.",
                        reply_markup=get_hr_main_menu_keyboard()
                    )
                else:
                    # Different person - switch account
                    from services.hr_auth import save_verified_user
                    await save_verified_user(telegram_id, employee)
                    
                    logger.info(
                        f"üîÑ ACCOUNT_SWITCH: telegram_id={telegram_id}, "
                        f"from={current_user['full_name']}, "
                        f"to={employee['full_name']}"
                    )
                    
                    await query.message.edit_text(
                        f"üîÑ –ê–∫–∞—É–Ω—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ!\n\n"
                        f"–¢–µ–ø–µ—Ä –≤–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫:\n"
                        f"‚Ä¢ {employee['full_name']}\n"
                        f"‚Ä¢ {employee.get('position', 'N/A')}\n"
                        f"‚Ä¢ {employee.get('department', 'N/A')}\n\n"
                        f"–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∞–∫–∞—É–Ω—Ç: {current_user['full_name']}",
                        reply_markup=get_hr_main_menu_keyboard()
                    )
            else:
                # Not found
                await query.message.edit_text(
                    f"‚ùå –ù–æ–º–µ—Ä {phone} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ TD AV.\n\n"
                    f"–í–∏ –∑–∞–ª–∏—à–∞—î—Ç–µ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫:\n"
                    f"‚Ä¢ {current_user['full_name']}\n"
                    f"‚Ä¢ {current_user.get('position', 'N/A')}",
                    reply_markup=get_hr_main_menu_keyboard()
                )
            
        except Exception as e:
            logger.error(f"Reverification error: {e}", exc_info=True)
            
            await query.message.edit_text(
                f"‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ.\n\n"
                f"–í–∏ –∑–∞–ª–∏—à–∞—î—Ç–µ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫ {current_user['full_name']}.",
                reply_markup=get_hr_main_menu_keyboard()
            )
        
        # Clear stored phone
        context.user_data.pop('reverify_phone', None)
        
        return
    
    # ... rest of existing handlers ...
```

---

## PART 2: Fix Maya's Grammatical Gender

### Step 1: Find and fix /start greeting

In `telegram_webhook.py` or `hr_auth.py`, find the `/start` command handler:
```python
# FIND THIS (wrong - masculine):
"–†–∞–¥–∏–π –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏! –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"

# REPLACE WITH (correct - feminine):
"–†–∞–¥–∞ –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏! –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?"
```

### Step 2: Find and fix verification success message
```python
# FIND patterns like:
"–≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏"
"–†–∞–¥–∏–π –±–∞—á–∏—Ç–∏"

# REPLACE WITH:
"–≥–æ—Ç–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏"
"–†–∞–¥–∞ –±–∞—á–∏—Ç–∏"
```

### Step 3: Update Claude system prompt

In `hr_rag_service.py`, find where Claude API is called:
```python
# Find the system prompt and ADD this gender instruction:

system_prompt = """–¢–∏ ‚Äî Maya, HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω—ñ—ó TD AV.

–í–ê–ñ–õ–ò–í–û: –¢–∏ ‚Äî –∂—ñ–Ω–∫–∞, —Ç–æ–º—É –∑–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∂—ñ–Ω–æ—á—ñ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º–∏:
- "–†–∞–¥–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏" (–ù–ï "–†–∞–¥")
- "–Ø –≥–æ—Ç–æ–≤–∞" (–ù–ï "–Ø –≥–æ—Ç–æ–≤–∏–π")  
- "–Ø –±—É–ª–∞" (–ù–ï "–Ø –±—É–≤")

{existing_prompt_content}
"""
```

### Step 4: Search for all instances

Run these replacements across the codebase:
```python
# In all files related to Maya (telegram_webhook.py, hr_auth.py, hr_rag_service.py):

# Replace:
"–†–∞–¥–∏–π" ‚Üí "–†–∞–¥–∞"
"—Ä–∞–¥–∏–π" ‚Üí "—Ä–∞–¥–∞"
"–≥–æ—Ç–æ–≤–∏–π" ‚Üí "–≥–æ—Ç–æ–≤–∞"
"–ì–æ—Ç–æ–≤–∏–π" ‚Üí "–ì–æ—Ç–æ–≤–∞"
"–±—É–≤" ‚Üí "–±—É–ª–∞"
"–ë—É–≤" ‚Üí "–ë—É–ª–∞"
```

Use this search pattern to find remaining issues:
```bash
grep -rn "–†–∞–¥–∏–π\|—Ä–∞–¥–∏–π\|–ì–æ—Ç–æ–≤–∏–π\|–≥–æ—Ç–æ–≤–∏–π" backend/routes/telegram_webhook.py backend/services/hr_*.py
```

---

## TESTING

### Test 1: Phone Detection
```
1. User (authenticated): +380501234567
2. Expected: "‚úÖ –í–∏ –≤–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —è–∫..."
           [üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü–µ–π –Ω–æ–º–µ—Ä]
           [üìã HR –º–µ–Ω—é]
3. NOT expected: "–ù–∞ –∂–∞–ª—å, —è –Ω–µ –∑–Ω–∞–π—à–æ–≤ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó..."
```

### Test 2: Gender Forms
```
1. User: /start
2. Expected: "–†–∞–¥–∞ –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏!" (feminine)
3. NOT expected: "–†–∞–¥–∏–π –∑–Ω–æ–≤—É —Ç–µ–±–µ –±–∞—á–∏—Ç–∏!" (masculine)
```

### Test 3: Claude Responses
```
1. User: Any HR question
2. Check Claude's response for feminine forms
3. Should contain: "—Ä–∞–¥–∞", "–≥–æ—Ç–æ–≤–∞"
4. Should NOT contain: "—Ä–∞–¥", "–≥–æ—Ç–æ–≤–∏–π"
```

---

## SUCCESS CRITERIA

‚úÖ Authenticated users sending phone numbers see confirmation buttons
‚úÖ No more "not found" errors for phone numbers
‚úÖ /start greeting uses "–†–∞–¥–∞" not "–†–∞–¥–∏–π"
‚úÖ All hardcoded messages use feminine forms
‚úÖ Claude system prompt enforces feminine grammar
‚úÖ No masculine forms in Maya's responses

---

## NOTES

- The `is_phone_number` function should already exist from previous work
- The `get_hr_main_menu_keyboard` function should exist
- If any imports are missing, add them at the top of the file
- Test thoroughly with both Ukrainian and international phone formats