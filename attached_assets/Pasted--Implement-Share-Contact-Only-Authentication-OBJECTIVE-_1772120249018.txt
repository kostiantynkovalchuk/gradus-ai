# Implement Share Contact-Only Authentication

## OBJECTIVE
Remove manual phone entry option. Force users to share their Telegram contact for security and UX benefits.

## CHANGES NEEDED

### 1. Update /start Welcome Message

**File:** `backend/routes/telegram_webhook.py` or `backend/services/hr_auth.py`

Find the welcome message for new users and update to:
```python
async def send_welcome_and_auth(chat_id: int, user_first_name: str):
    """Send welcome message with Share Contact button only."""
    
    welcome_text = (
        f"üëã –ü—Ä–∏–≤—ñ—Ç, {user_first_name}! –Ø Maya ‚Äî —Ç–≤—ñ–π HR-–∞—Å–∏—Å—Ç–µ–Ω—Ç —É –¢–æ—Ä–≥–æ–≤–æ–º—É –î–æ–º—ñ –ê–í.\n\n"
        f"üéØ –î–æ–ø–æ–º–æ–∂—É –∑:\n"
        f"‚Ä¢ –í—ñ–¥–ø—É—Å—Ç–∫–∞–º–∏ —Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç–æ—é üí∞\n"
        f"‚Ä¢ –¢–µ—Ö–ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é (–ë–ª—ñ—Ü, –£–†–°, –¥–æ—Å—Ç—É–ø–∏) üîß\n"
        f"‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏ üìã\n"
        f"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç—ñ–≤ üìû\n\n"
        f"–î–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏ —Å–≤—ñ–π —Ä–æ–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É ‚ö°"
    )
    
    # Share Contact button (native Telegram request)
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton("üì± –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É", request_contact=True)]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    
    await send_telegram_message(chat_id, welcome_text, reply_markup=keyboard)
```

### 2. Handle Contact Sharing

**File:** `backend/routes/telegram_webhook.py`

Add handler for when user shares contact:
```python
@router.message(F.contact)
async def handle_contact_shared(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    Handle when user shares their Telegram contact.
    Triggered by Share Contact button.
    """
    
    contact = update.message.contact
    telegram_id = update.effective_user.id
    user_first_name = update.effective_user.first_name
    
    # Verify it's their own contact (security check)
    if contact.user_id != telegram_id:
        await update.message.reply_text(
            "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º –≤–ª–∞—Å–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º, –∞ –Ω–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–º —ñ–Ω—à–æ—ó –æ—Å–æ–±–∏.",
            reply_markup=ReplyKeyboardRemove()
        )
        return
    
    phone = contact.phone_number
    
    logger.info(
        f"VERIFY_CONTACT_SHARED: telegram_id={telegram_id}, "
        f"phone={phone[:4]}***{phone[-4:]}"
    )
    
    # Show loading message
    await update.message.reply_text(
        f"üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–æ–º–µ—Ä {phone}...",
        reply_markup=ReplyKeyboardRemove()
    )
    
    try:
        # Verify with SED
        from services.hr_sed_service import sed_service
        
        result = await sed_service.verify_employee(phone)
        
        if result['verified']:
            employee = result['employee']
            
            # Save to database
            from services.hr_auth import save_verified_user
            await save_verified_user(telegram_id, employee)
            
            logger.info(
                f"VERIFY_SUCCESS: telegram_id={telegram_id}, "
                f"name={employee['full_name']}, "
                f"position={employee.get('position', 'N/A')}"
            )
            
            # Success message with main menu
            success_text = (
                f"‚úÖ –í—ñ—Ç–∞—é, {employee['full_name']}!\n\n"
                f"–í–∏ —É—Å–ø—ñ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.\n"
                f"üìã –ü–æ—Å–∞–¥–∞: {employee.get('position', 'N/A')}\n"
                f"üè¢ –í—ñ–¥–¥—ñ–ª: {employee.get('department', 'N/A')}\n\n"
                f"–ì–æ—Ç–æ–≤–∞ –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ HR-–ø–∏—Ç–∞–Ω–Ω—è–º–∏! üí¨"
            )
            
            await update.message.reply_text(
                success_text,
                reply_markup=get_main_menu_keyboard()
            )
            
        else:
            # Not found in SED
            logger.warning(
                f"VERIFY_FAILED: telegram_id={telegram_id}, "
                f"phone={phone}, error=not_found"
            )
            
            await update.message.reply_text(
                f"‚ùå –ù–æ–º–µ—Ä {phone} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ TD AV.\n\n"
                f"–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n"
                f"‚Ä¢ –ù–æ–º–µ—Ä –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ —Ä–æ–±–æ—á–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º\n"
                f"‚Ä¢ –í–∏ —â–µ –Ω–µ –¥–æ–¥–∞–Ω—ñ –≤ —Å–∏—Å—Ç–µ–º—É\n\n"
                f"–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ HR-–≤—ñ–¥–¥—ñ–ª—É:\n"
                f"üìß hr@vinkom.net\n"
                f"‚òéÔ∏è –ù–∞—Ç–∞–ª—ñ—è –†–µ—à–µ—Ç—ñ–ª–æ–≤–∞"
            )
            
            # Notify HR admins
            from services.hr_auth import notify_hr_admins_about_failed_verification
            await notify_hr_admins_about_failed_verification(
                telegram_id,
                user_first_name,
                phone
            )
            
    except Exception as e:
        logger.error(f"Contact verification error: {e}", exc_info=True)
        
        await update.message.reply_text(
            "‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.\n\n"
            "–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ HR-–≤—ñ–¥–¥—ñ–ª—É."
        )
```

### 3. Remove Manual Entry Code

**Remove these handlers/functions:**
- Phone number text detection for unverified users
- Phone confirmation buttons (hr_verify_phone:confirm)
- Manual phone input prompts
- `PENDING_VERIFICATIONS` dictionary (no longer needed)

**Keep:**
- Phone detection for VERIFIED users (authenticated user sending phone scenario)

### 4. Update Unverified User Message Handler

**File:** `backend/routes/telegram_webhook.py`

Update the handler for messages from unverified users:
```python
@router.message(F.text & ~F.command())
async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Route user messages."""
    
    telegram_id = update.effective_user.id
    user = await get_user_by_telegram_id(db, telegram_id)
    
    if not user or not user.get('is_active'):
        # Unverified user ‚Üí trigger auth flow
        logger.info(f"üö´ Unverified user sent message: telegram_id={telegram_id}")
        
        await send_welcome_and_auth(
            update.message.chat_id,
            update.effective_user.first_name
        )
        return
    
    # Verified user ‚Üí continue with normal flow
    # ... existing HR question handling ...
```

### 5. Security: Prevent Contact Spoofing

The check `if contact.user_id != telegram_id` ensures users can only share THEIR OWN contact, not someone else's from their contact list.

## TESTING

After implementation, test these scenarios:

**Test 1: Normal flow (happy path)**
```
1. New user taps /start
2. Sees welcome + [–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –Ω–æ–º–µ—Ä–æ–º] button
3. Taps button ‚Üí Telegram dialog appears
4. Confirms ‚Üí Phone sent to bot
5. Verified successfully
```

**Test 2: Wrong contact shared**
```
1. User shares contact of colleague from contact list
2. Bot detects: contact.user_id ‚â† telegram_id
3. Shows error: "–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º –≤–ª–∞—Å–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º"
```

**Test 3: Phone not in SED**
```
1. User shares their contact
2. Phone not found in SED database
3. Shows helpful error + HR contacts
4. HR admins notified automatically
```

**Test 4: Unverified user sends message**
```
1. Unverified user types "–ü—Ä–∏–≤—ñ—Ç"
2. Bot shows welcome + auth button
3. User must verify before continuing
```

## SUCCESS CRITERIA

‚úÖ Manual entry option completely removed
‚úÖ Only Share Contact button shown
‚úÖ Native Telegram contact dialog works
‚úÖ Spoofing prevention (can't share others' contacts)
‚úÖ Error handling for failed verification
‚úÖ HR admins notified of failures
‚úÖ Verified users get main menu

## SECURITY BENEFITS

‚úÖ Users MUST share their actual Telegram phone
‚úÖ Can't type colleague's number
‚úÖ Can't test random numbers
‚úÖ Can't brute force database
‚úÖ Enforces "Telegram phone = Work phone" policy